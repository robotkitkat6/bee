<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Rider — Đặt xe</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    /* Biến màu */
    :root {
        --primary-color: #007bff; /* Blue */
        --success-color: #28a745; /* Green */
        --danger-color: #dc3545; /* Red */
    }

    body{
        font-family:Arial;
        margin:0;
        padding:12px;
        /* Thêm padding dưới để tránh nội dung bị che bởi Overlay */
        padding-bottom: 120px; 
    }
    #map{
        height:50vh;
        margin-top:8px;
    }
    input, select, button{
        padding:8px;
        margin:6px 0;
        width:100%;
        box-sizing:border-box;
        border-radius: 6px;
        border: 1px solid #ccc;
    }
    button {
        cursor: pointer;
        font-weight: bold;
    }
    #estimateBtn { background-color: #f8f9fa; }
    #requestBtn { background-color: var(--primary-color); color: white; }
    
    .row{display:flex;gap:8px}
    .col{flex:1}

    /* === 1. Bảng Điều khiển Trạng thái Cuốc xe (Overlay) === */
    #rideStatusOverlay {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        max-height: 90vh;
        background-color: white;
        border-top-left-radius: 15px;
        border-top-right-radius: 15px;
        box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.2);
        padding: 15px;
        transition: transform 0.3s ease-out;
        z-index: 500;
        overflow-y: auto;
        box-sizing: border-box;
        display: none; /* Mặc định ẩn */
    }

    /* Chế độ thu nhỏ */
    #rideStatusOverlay.default-view {
        /* Hiện khoảng 120px từ dưới lên */
        transform: translateY(calc(100% - 120px)); 
    }
    /* Chế độ mở rộng */
    #rideStatusOverlay.expanded-view {
        transform: translateY(0);
    }
    /* Các style phụ cho Overlay */
    #statusTitle {
        font-weight: bold;
        color: var(--primary-color);
        text-align: center;
        margin-bottom: 10px;
        cursor: pointer; /* Cho phép click để mở rộng/thu nhỏ */
    }
    .status-finding { color: orange; }
    .status-accepted { color: var(--success-color); }
    .status-completed { color: #333; }
    .status-canceled { color: var(--danger-color); }
  </style>
</head>
<body>
  <h2>Đặt xe — Nhập địa chỉ</h2>

  <label>Điểm đón</label>
  <input id="from" placeholder="Ví dụ: 1 Phố A, Quận B" />

  <label>Điểm đến</label>
  <input id="to" placeholder="Ví dụ: 2 Phố X, Quận Y" />

  <label>Chọn loại xe</label>
  <select id="vehicle">
    <option value="bike">Xe máy</option>
    <option value="car">Ô tô</option>
  </select>

  <div class="row">
    <button id="estimateBtn" class="col">Ước tính & Hiển thị tuyến</button>
    <button id="requestBtn" class="col" disabled>Gọi xe (lưu)</button>
  </div>

  <div id="info"></div>
  <div id="map"></div>

  <div id="rideStatusOverlay">
      <div id="statusTitle">TRẠNG THÁI CUỐC XE</div>
      <div id="rideStatusContent">
          </div>
      <div style="margin-top: 15px;">
          <button id="cancelRideBtn" style="background-color: var(--danger-color); color: white; display: none;">
              HỦY CUỐC XE
          </button>
      </div>
  </div>


  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.min.js"></script>
  <script src="https://unpkg.com/leaflet-markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { 
        getDatabase, push, ref, onValue, remove, update
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // ====== Cấu hình Firebase ======
    const firebaseConfig = {
      apiKey: "AIzaSyCUQpfPPlJqLRm9FyryfX2UOa82mUWbJrE",
      authDomain: "robotkitkat6-bee.firebaseapp.com",
      databaseURL: "https://robotkitkat6-bee-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "robotkitkat6-bee",
      storageBucket: "robotkitkat6-bee.firebasestorage.app",
      messagingSenderId: "117130770804",
      appId: "1:117130770804:web:4827cc61a7c9df99549421",
      measurementId: "G-WMKP4GT930"
    };
    // =============================================

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Map init
    const map = L.map('map').setView([10.762622, 106.660172], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let routingControl = null;
    let lastRouteSummary = null; // {distance (m), duration (s)}
    let currentRideId = null;
    let driverMarker = null;

    // Biến mới cho vị trí người đặt xe
    let riderCurrentMarker = null;
    let riderCurrentPos = null; // {lat, lng, display}

    // Elements
    const infoDiv = document.getElementById('info');
    const estimateBtn = document.getElementById('estimateBtn');
    const requestBtn = document.getElementById('requestBtn');
    const rideStatusOverlay = document.getElementById('rideStatusOverlay');
    const statusTitle = document.getElementById('statusTitle');
    const rideStatusContent = document.getElementById('rideStatusContent');
    const cancelRideBtn = document.getElementById('cancelRideBtn');

    // Pricing
    const PRICE = { bikePerKm: 6000, carPerKm: 10000, bikeMin: 10000, carMin: 20000 };

    // Hàm Utility: Hiển thị/Ẩn Control Overlay
    function toggleControlOverlay(state = 'default') {
        rideStatusOverlay.classList.remove('default-view', 'expanded-view');
        if (state === 'default') {
            rideStatusOverlay.classList.add('default-view');
        } else if (state === 'expanded') {
            rideStatusOverlay.classList.add('expanded-view');
        }
    }
    
    // Sự kiện mở rộng/thu nhỏ Overlay
    statusTitle.addEventListener('click', () => {
        if (rideStatusOverlay.classList.contains('default-view')) {
            toggleControlOverlay('expanded');
        } else {
            toggleControlOverlay('default');
        }
    });
    
    // Sự kiện click ra Map để thu nhỏ Overlay
    map.on('click', () => {
        if (rideStatusOverlay.classList.contains('expanded-view')) {
            toggleControlOverlay('default');
        }
    });

    // === CHỨC NĂNG ĐỊNH VỊ VÀ ĐỀ XUẤT ĐỊA CHỈ ===

    // Reverse Geocode via Nominatim
    async function reverseGeocode(lat, lng) {
      const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`;
      const res = await fetch(url, { headers: { 'Accept-Language': 'vi' } });
      const data = await res.json();
      if (data && data.display_name) {
        return data.display_name;
      }
      return `Vị trí (${lat.toFixed(4)}, ${lng.toFixed(4)})`;
    }

    // Get current location, update map, and fill 'from' input
    function getCurrentLocationAndInitMap() {
        if (!navigator.geolocation) {
            infoDiv.innerHTML = `<div style="color:var(--danger-color);">Trình duyệt không hỗ trợ định vị. Vui lòng nhập địa chỉ.</div>`;
            return;
        }

        infoDiv.innerHTML = `<div style="color:var(--primary-color);">Đang tìm vị trí hiện tại...</div>`;

        // Attempt to get high accuracy position
        navigator.geolocation.getCurrentPosition(async (pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            riderCurrentPos = { lat, lng };

            // Center map and add marker
            map.setView([lat, lng], 16);
            if (riderCurrentMarker) map.removeLayer(riderCurrentMarker); // Xóa marker cũ nếu có
            riderCurrentMarker = L.marker([lat, lng]).addTo(map);
            riderCurrentMarker.bindPopup("Vị trí của bạn").openPopup();

            // Reverse Geocode to fill 'from' input
            try {
                const addressText = await reverseGeocode(lat, lng);
                riderCurrentPos.display = addressText;
                // Đề xuất địa chỉ (tự động điền)
                document.getElementById('from').value = addressText; 
                infoDiv.innerHTML = `<div style="color:var(--success-color);">Đã tìm thấy vị trí hiện tại: ${addressText.split(',').slice(0, 2).join(',')}</div>`;
            } catch (e) {
                console.error("Lỗi reverse geocode:", e);
                document.getElementById('from').value = `(${lat.toFixed(6)}, ${lng.toFixed(6)})`;
            }

        }, (err) => {
            console.warn(`Lỗi định vị: ${err.code} - ${err.message}`);
            infoDiv.innerHTML = `<div style="color:var(--danger-color);">Không lấy được vị trí hiện tại. Vui lòng nhập địa chỉ.</div>`;
        }, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 });
    }
    // END CHỨC NĂNG ĐỊNH VỊ

    // Estimate route using Leaflet Routing Machine (OSRM public)
    function showRoute(fromCoords, toCoords) {
      if (routingControl) { map.removeControl(routingControl); routingControl = null; lastRouteSummary = null; }
      routingControl = L.Routing.control({
        waypoints: [
          L.latLng(fromCoords.lat, fromCoords.lng),
          L.latLng(toCoords.lat, toCoords.lng)
        ],
        router: L.Routing.osrmv1({serviceUrl: 'https://router.project-osrm.org/route/v1'}),
        addWaypoints: false,
        draggableWaypoints: false,
        fitSelectedRoutes: true,
        showAlternatives: false
      }).addTo(map);

      routingControl.on('routesfound', function(e) {
        const route = e.routes[0];
        lastRouteSummary = { distance: route.summary.totalDistance, duration: route.summary.totalTime };
        displayInfo();
        requestBtn.disabled = false;
      });
    }

    function displayInfo() {
      if (!lastRouteSummary) return;
      const km = (lastRouteSummary.distance / 1000);
      const mins = Math.round(lastRouteSummary.duration / 60);
      const vehicle = document.getElementById('vehicle').value;
      let priceCalc = 0;
      if (vehicle === 'bike') {
        priceCalc = Math.max(Math.round(km * PRICE.bikePerKm), PRICE.bikeMin);
      } else {
        priceCalc = Math.max(Math.round(km * PRICE.carPerKm), PRICE.carMin);
      }
      infoDiv.innerHTML = `
        <div><b>Khoảng cách:</b> ${km.toFixed(2)} km</div>
        <div><b>Thời gian dự kiến:</b> ${mins} phút</div>
        <div><b>Loại xe:</b> ${vehicle === 'bike' ? 'Xe máy' : 'Ô tô'}</div>
        <div><b>Giá ước tính:</b> ${priceCalc.toLocaleString()} đ</div>
      `;
    }

    // === HÀM CẬP NHẬT TRẠNG THÁI CUỐC XE ===
    function updateRideStatusUI(ride) {
        if (!rideStatusOverlay.style.display || rideStatusOverlay.style.display === 'none') {
            rideStatusOverlay.style.display = 'block';
            toggleControlOverlay('expanded'); // Mở rộng khi bắt đầu
        }

        let titleText = `Cuốc xe #${currentRideId.slice(-4)}`;
        let contentHTML = '';
        let showCancel = true;
        
        statusTitle.classList.remove('status-finding', 'status-accepted', 'status-completed', 'status-canceled');

        switch (ride.status) {
            case 'finding':
                titleText = 'Đang tìm tài xế...';
                statusTitle.classList.add('status-finding');
                contentHTML = `
                    <p style="text-align:center; font-weight:bold; color:orange;">Đang gửi yêu cầu đến các tài xế gần bạn.</p>
                    <p>Vui lòng chờ chấp nhận (3 phút).</p>
                `;
                break;
            case 'accepted':
                titleText = `Tài xế ${ride.driverName.split('-')[0].trim()} đã nhận cuốc!`;
                statusTitle.classList.add('status-accepted');
                contentHTML = `
                    <p><b>Tài xế:</b> ${ride.driverName}</p>
                    <p><b>Trạng thái:</b> Đang trên đường đến điểm đón.</p>
                `;
                break;
            case 'onTrip':
                titleText = 'Đang trên đường đi';
                statusTitle.classList.add('status-accepted');
                contentHTML = `
                    <p><b>Tài xế:</b> ${ride.driverName}</p>
                    <p><b>Trạng thái:</b> Đã đón khách, đang di chuyển đến điểm đến.</p>
                `;
                break;
            case 'completed':
                titleText = 'Cuốc xe hoàn thành!';
                statusTitle.classList.add('status-completed');
                contentHTML = `
                    <p style="text-align:center; font-weight:bold; color:var(--success-color);">Cảm ơn bạn đã sử dụng dịch vụ!</p>
                    <p>Tổng tiền: ${ride.fare ? ride.fare.toLocaleString() + ' đ' : '—'}</p>
                `;
                showCancel = false;
                break;
            case 'canceled':
                titleText = 'Cuốc xe đã bị HỦY';
                statusTitle.classList.add('status-canceled');
                contentHTML = `<p style="text-align:center; font-weight:bold; color:var(--danger-color);">Cuốc xe đã bị hủy bởi bạn hoặc tài xế.</p>`;
                showCancel = false;
                break;
            default:
                titleText = 'Lỗi trạng thái';
                showCancel = false;
        }

        statusTitle.innerHTML = titleText;
        rideStatusContent.innerHTML = contentHTML;
        cancelRideBtn.style.display = showCancel ? 'block' : 'none';

        // Cập nhật vị trí tài xế trên bản đồ
        if (ride.driverLat && ride.driverLng) {
            const driverCoords = L.latLng(ride.driverLat, ride.driverLng);
            if (!driverMarker) {
                driverMarker = L.marker(driverCoords, { icon: L.icon({
                    iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
                }) }).addTo(map);
                driverMarker.bindPopup("Tài xế của bạn").openPopup();
            } else {
                driverMarker.setLatLng(driverCoords);
            }
        } else if (driverMarker) {
            map.removeLayer(driverMarker);
            driverMarker = null;
        }
    }
    
    // === HÀM LẮNG NGHE TRẠNG THÁI CUỐC XE ===
    function listenToRide(rideId) {
        currentRideId = rideId;
        const rideRef = ref(db, 'rides/' + rideId);
        
        onValue(rideRef, (snapshot) => {
            const ride = snapshot.val();
            if (ride) {
                updateRideStatusUI(ride);
                // Nếu cuốc xe hoàn thành hoặc bị hủy, dừng lắng nghe sau một thời gian
                if (ride.status === 'completed' || ride.status === 'canceled') {
                     // Dừng lắng nghe sau 5 giây để người dùng xem thông báo
                    setTimeout(() => {
                        rideStatusOverlay.style.display = 'none';
                        currentRideId = null;
                        if (driverMarker) map.removeLayer(driverMarker);
                        driverMarker = null;
                        // Mở lại form input
                        document.getElementById('from').disabled = false;
                        document.getElementById('to').disabled = false;
                        document.getElementById('vehicle').disabled = false;
                        requestBtn.disabled = true; // Vô hiệu hóa nút gọi xe cho đến khi ước tính lại
                    }, 5000);
                }
            } else {
                // Cuốc xe bị xóa khỏi DB (hoàn thành/hủy bởi tài xế)
                updateRideStatusUI({ status: 'canceled', fare: 0 }); // Giả định là bị hủy
                setTimeout(() => {
                    rideStatusOverlay.style.display = 'none';
                    currentRideId = null;
                    if (driverMarker) map.removeLayer(driverMarker);
                    driverMarker = null;
                    // Mở lại form input
                    document.getElementById('from').disabled = false;
                    document.getElementById('to').disabled = false;
                    document.getElementById('vehicle').disabled = false;
                    requestBtn.disabled = true; 
                }, 5000);
            }
        });
        
        cancelRideBtn.onclick = () => cancelRide(rideId);
    }
    
    // === HÀM HỦY CUỐC XE ===
    async function cancelRide(rideId) {
        if (!confirm("Bạn chắc chắn muốn hủy cuốc xe này?")) return;
        try {
            const rideRef = ref(db, 'rides/' + rideId);
            // Cập nhật trạng thái thành 'canceled' trước khi xóa (tùy chọn)
            await update(rideRef, { status: 'canceled', canceledBy: 'rider', canceledAt: Date.now() });
            // Sau đó xóa nó (việc này sẽ kích hoạt onValue và xử lý UI)
            await remove(rideRef);
            alert("Cuốc xe đã được hủy.");
        } catch (e) {
            alert('Lỗi hủy cuốc: ' + (e.message || e));
        }
    }

    // Button: Estimate
    estimateBtn.addEventListener('click', async () => {
      const from = document.getElementById('from').value.trim();
      const to = document.getElementById('to').value.trim();
      if (!from || !to) return alert('Nhập điểm đón và điểm đến');
      try {
        if (currentRideId) return alert("Bạn đang có cuốc xe đang hoạt động!");
        estimateBtn.disabled = true;
        infoDiv.innerHTML = 'Đang tìm địa chỉ...';
        const fromCoords = await geocode(from);
        const toCoords = await geocode(to);
        showRoute(fromCoords, toCoords);
      } catch (e) {
        alert(e.message || 'Lỗi khi geocode');
      } finally {
        estimateBtn.disabled = false;
      }
    });

    // Button: Request (push ride into /rides)
    requestBtn.addEventListener('click', async () => {
      if (!lastRouteSummary) return alert('Chưa có tuyến');
      if (currentRideId) return alert("Bạn đang có cuốc xe đang hoạt động!");

      const from = document.getElementById('from').value.trim();
      const to = document.getElementById('to').value.trim();
      const vehicle = document.getElementById('vehicle').value;
      const km = lastRouteSummary.distance / 1000;
      const mins = Math.round(lastRouteSummary.duration / 60);

      // calculate fare
      let fare = 0;
      if (vehicle === 'bike') fare = Math.max(Math.round(km * PRICE.bikePerKm), PRICE.bikeMin);
      else fare = Math.max(Math.round(km * PRICE.carPerKm), PRICE.carMin);

      // FIX LỖI: Lấy tọa độ từ waypoint object phải dùng .latLng
      const waypointFrom = routingControl.getWaypoints()[0].latLng;
      const waypointTo = routingControl.getWaypoints()[1].latLng;

      // create ride object
      const ride = {
        createdAt: Date.now(),
        status: 'finding',
        fromText: from,
        toText: to,
        // SỬA LỖI NÚT GỌI XE
        from: { lat: waypointFrom.lat, lng: waypointFrom.lng }, 
        to: { lat: waypointTo.lat, lng: waypointTo.lng },
        distance_m: lastRouteSummary.distance,
        duration_s: lastRouteSummary.duration,
        distance_km: km,
        duration_min: mins,
        fare: fare,
        vehicle: vehicle
      };

      try {
        const ridesRef = ref(db, 'rides');
        requestBtn.disabled = true;
        const newRef = await push(ridesRef, ride);
        
        infoDiv.innerHTML = `<div style="color:blue">Đã gọi xe. ID: ${newRef.key}. Đang tìm tài xế...</div>`;
        
        // Bắt đầu lắng nghe trạng thái cuốc xe
        listenToRide(newRef.key);

        // Vô hiệu hóa form input sau khi gọi xe
        document.getElementById('from').disabled = true;
        document.getElementById('to').disabled = true;
        document.getElementById('vehicle').disabled = true;

      } catch (e) {
        alert('Lỗi gửi yêu cầu: ' + (e.message || e));
        requestBtn.disabled = false;
      }
    });

    // Gọi hàm định vị khi trang được tải
    getCurrentLocationAndInitMap();

  </script>
</body>
</html>
