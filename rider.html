<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Rider ‚Äî ƒê·∫∑t xe</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="style.css" /> </head>
<body>
  <h2>ƒê·∫∑t xe ‚Äî Nh·∫≠p ƒë·ªãa ch·ªâ</h2>

  <label>ƒêi·ªÉm ƒë√≥n</label>
  <input id="from" placeholder="V√≠ d·ª•: 1 Ph·ªë A, Qu·∫≠n B" />

  <label>ƒêi·ªÉm ƒë·∫øn</label>
  <input id="to" placeholder="V√≠ d·ª•: 2 Ph·ªë X, Qu·∫≠n Y" />

  <label>Ch·ªçn lo·∫°i xe</label>
  <select id="vehicle">
    <option value="bike">Xe m√°y</option>
    <option value="car">√î t√¥</option>
  </select>

  <div class="row">
    <button id="estimateBtn" class="col btn btn-primary">∆Ø·ªõc t√≠nh & Hi·ªÉn th·ªã tuy·∫øn</button>
    <button id="requestBtn" class="col btn btn-secondary" disabled>G·ªçi xe (l∆∞u)</button>
    <button id="cancelBtn" class="col btn btn-danger" style="display:none;" disabled>H·ªßy chuy·∫øn</button>
  </div>

  <div id="info"></div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, push, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // C·∫•u h√¨nh Firebase (ƒê√£ ƒë·ªìng b·ªô)
    const firebaseConfig = {
      apiKey: "AIzaSyCUQpfPPlJqLRm9FyryfX2UOa82mUWbJrE",
      authDomain: "robotkitkat6-bee.firebaseapp.com",
      databaseURL: "https://robotkitkat6-bee-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "robotkitkat6-bee",
      storageBucket: "robotkitkat6-bee.firebasestorage.app",
      messagingSenderId: "117130770804",
      appId: "1:117130770804:web:4827cc61a7c9df99549421",
      measurementId: "G-WMKP4GT930"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Map init
    const map = L.map('map').setView([10.762622, 106.660172], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let routingControl = null;
    let lastRouteSummary = null; 
    let lastFromCoords = null; 
    let lastToCoords = null;   
    let currentRideId = null; 

    const infoDiv = document.getElementById('info');
    const estimateBtn = document.getElementById('estimateBtn');
    const requestBtn = document.getElementById('requestBtn');
    const cancelBtn = document.getElementById('cancelBtn');

    // Pricing
    const PRICE = { bikePerKm: 6000, carPerKm: 10000, bikeMin: 10000, carMin: 20000 };

    // Geocode via Nominatim (Gi·ªØ nguy√™n)
    async function geocode(q) {
      const url = 'https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(q);
      const res = await fetch(url, { headers: { 'Accept-Language': 'vi' } });
      const arr = await res.json();
      if (!arr || !arr.length) throw new Error('Kh√¥ng t√¨m th·∫•y ƒë·ªãa ƒëi·ªÉm: ' + q);
      return { lat: parseFloat(arr[0].lat), lng: parseFloat(arr[0].lon), display: arr[0].display_name };
    }

    // Estimate route using Leaflet Routing Machine (Gi·ªØ nguy√™n)
    function showRoute(fromCoords, toCoords) {
      if (routingControl) { map.removeControl(routingControl); routingControl = null; lastRouteSummary = null; }
      routingControl = L.Routing.control({
        waypoints: [
          L.latLng(fromCoords.lat, fromCoords.lng),
          L.latLng(toCoords.lat, toCoords.lng)
        ],
        router: L.Routing.osrmv1({serviceUrl: 'https://router.project-osrm.org/route/v1'}),
        addWaypoints: false,
        draggableWaypoints: false,
        fitSelectedRoutes: true,
        showAlternatives: false
      }).addTo(map);

      routingControl.on('routesfound', function(e) {
        const route = e.routes[0];
        lastRouteSummary = { distance: route.summary.totalDistance, duration: route.summary.totalTime };
        displayInfo();
        requestBtn.disabled = false;
      });

      routingControl.on('routingerror', function(e) {
         lastRouteSummary = null;
         requestBtn.disabled = true;
         infoDiv.innerHTML = `<div><b>L·ªói:</b> Kh√¥ng t√¨m th·∫•y tuy·∫øn ƒë∆∞·ªùng.</div>`;
      });
    }

    function displayInfo() {
      if (!lastRouteSummary) return;
      const km = (lastRouteSummary.distance / 1000);
      const mins = Math.round(lastRouteSummary.duration / 60);
      const vehicle = document.getElementById('vehicle').value;
      let priceCalc = 0;
      if (vehicle === 'bike') {
        priceCalc = Math.max(Math.round(km * PRICE.bikePerKm), PRICE.bikeMin);
      } else {
        priceCalc = Math.max(Math.round(km * PRICE.carPerKm), PRICE.carMin);
      }
      infoDiv.innerHTML = `
        <div><b>Kho·∫£ng c√°ch:</b> ${km.toFixed(2)} km</div>
        <div><b>Th·ªùi gian d·ª± ki·∫øn:</b> ${mins} ph√∫t</div>
        <div><b>Lo·∫°i xe:</b> ${vehicle === 'bike' ? 'Xe m√°y' : '√î t√¥'}</div>
        <div><b>Gi√° ∆∞·ªõc t√≠nh:</b> ${priceCalc.toLocaleString()} ƒë</div>
      `;
    }
    
    // H√ÄM L·∫ÆNG NGHE TR·∫†NG TH√ÅI CU·ªêC XE (ƒê√É S·ª¨A)
    function listenForAcceptance(rideId) {
        const rideRef = ref(db, 'rides/' + rideId);
        onValue(rideRef, (snap) => {
            const ride = snap.val();
            
            if (!ride) {
                 // Cu·ªëc xe ƒë√£ b·ªã h·ªßy (b·ªüi rider/driver) ho·∫∑c ho√†n th√†nh
                 if (currentRideId === rideId) {
                     infoDiv.innerHTML = `<div style="color:var(--secondary-color); font-weight: bold; margin-top: 10px;">Cu·ªëc xe ƒë√£ k·∫øt th√∫c/b·ªã h·ªßy.</div>`;
                     cancelBtn.style.display = 'none';
                     requestBtn.disabled = false;
                     currentRideId = null;
                 }
                 return;
            }

            if (ride.status === 'accepted') {
                const driverName = ride.driverName || 'T√†i x·∫ø';
                infoDiv.innerHTML = `
                    <div style="color:var(--primary-color); font-weight: bold; font-size: 1.2em;">‚úÖ T√ÄI X·∫æ ƒê√É NH·∫¨N CU·ªêC!</div>
                    <div>T√†i x·∫ø <b>${driverName}</b> ƒëang ƒë·∫øn ƒë√≥n b·∫°n.</div>
                `;
            } else if (ride.status === 'onTrip') {
                 // TR·∫†NG TH√ÅI M·ªöI: ƒê√É ƒê√ìN KH√ÅCH
                const driverName = ride.driverName || 'T√†i x·∫ø';
                infoDiv.innerHTML = `
                    <div style="color:var(--success-color); font-weight: bold; font-size: 1.2em;">üöó B·∫ÆT ƒê·∫¶U H√ÄNH TR√åNH!</div>
                    <div>B·∫°n ƒëang tr√™n ƒë∆∞·ªùng ƒë·∫øn ƒëi·ªÉm ƒë·∫øn c√πng t√†i x·∫ø <b>${driverName}</b>.</div>
                `;
            } else if (ride.status === 'finding') {
                if (!infoDiv.innerHTML.includes('ƒêang t√¨m t√†i x·∫ø')) {
                    infoDiv.innerHTML += `<div style="color:var(--success-color); margin-top: 10px;">Y√™u c·∫ßu ƒë√£ g·ª≠i (ID: ${rideId}). ƒêang t√¨m t√†i x·∫ø...</div>`;
                }
            }
            // Lu√¥n b·∫≠t n√∫t h·ªßy n·∫øu ƒëang trong chuy·∫øn (finding/accepted/onTrip)
            if (ride.status !== 'completed' && ride.status !== 'canceled') {
                cancelBtn.style.display = 'inline-block';
                cancelBtn.disabled = false;
            }

        });
    }


    // Button: Estimate (Gi·ªØ nguy√™n)
    estimateBtn.addEventListener('click', async () => {
      const from = document.getElementById('from').value.trim();
      const to = document.getElementById('to').value.trim();
      if (!from || !to) return alert('Nh·∫≠p ƒëi·ªÉm ƒë√≥n v√† ƒëi·ªÉm ƒë·∫øn');
      try {
        estimateBtn.disabled = true;
        requestBtn.disabled = true;
        infoDiv.innerHTML = 'ƒêang t√¨m ƒë·ªãa ch·ªâ...';
        
        cancelBtn.style.display = 'none'; // ·∫®n n√∫t h·ªßy khi ∆∞·ªõc t√≠nh l·∫°i

        const fromCoords = await geocode(from);
        const toCoords = await geocode(to);

        lastFromCoords = fromCoords;
        lastToCoords = toCoords;

        showRoute(fromCoords, toCoords);
      } catch (e) {
        alert(e.message || 'L·ªói khi geocode');
        infoDiv.innerHTML = '';
        lastRouteSummary = null;
        lastFromCoords = null;
        lastToCoords = null;
      } finally {
        estimateBtn.disabled = false;
      }
    });

    // Button: Request (ƒê√£ s·ª≠a)
    requestBtn.addEventListener('click', async () => {
      if (!lastRouteSummary || !lastFromCoords || !lastToCoords) {
        return alert('Vui l√≤ng nh·∫•n "∆Ø·ªõc t√≠nh & Hi·ªÉn th·ªã tuy·∫øn" tr∆∞·ªõc v√† ƒë·∫£m b·∫£o t√¨m th·∫•y tuy·∫øn ƒë∆∞·ªùng.');
      }
      
      const from = document.getElementById('from').value.trim();
      const to = document.getElementById('to').value.trim();
      const vehicle = document.getElementById('vehicle').value;
      const km = lastRouteSummary.distance / 1000;
      const mins = Math.round(lastRouteSummary.duration / 60);

      let fare = 0;
      if (vehicle === 'bike') fare = Math.max(Math.round(km * PRICE.bikePerKm), PRICE.bikeMin);
      else fare = Math.max(Math.round(km * PRICE.carPerKm), PRICE.carMin);

      const ride = {
        createdAt: Date.now(),
        status: 'finding',
        fromText: from,
        toText: to,
        from: { lat: lastFromCoords.lat, lng: lastFromCoords.lng },
        to: { lat: lastToCoords.lat, lng: lastToCoords.lng },
        distance_m: lastRouteSummary.distance,
        duration_s: lastRouteSummary.duration,
        distance_km: km,
        duration_min: mins,
        fare: fare,
        vehicle: vehicle
      };

      try {
        const ridesRef = ref(db, 'rides');
        const newRef = await push(ridesRef, ride);
        const rideId = newRef.key;

        currentRideId = rideId; // L∆ØU ID CU·ªêC XE
        listenForAcceptance(rideId);
        
        requestBtn.disabled = true;
        // N√∫t h·ªßy s·∫Ω ƒë∆∞·ª£c b·∫≠t trong h√†m listenForAcceptance

      } catch (e) {
        alert('L·ªói g·ª≠i y√™u c·∫ßu: ' + (e.message || e));
      }
    });

    // N√öT M·ªöI: H·ª¶Y CHUY·∫æN (RIDER)
    cancelBtn.addEventListener('click', async () => {
        if (!currentRideId) return;

        // C·∫£nh b√°o n·∫øu chuy·∫øn ƒë√£ ƒë∆∞·ª£c t√†i x·∫ø nh·∫≠n
        const isAccepted = infoDiv.innerHTML.includes('T√ÄI X·∫æ ƒê√É NH·∫¨N CU·ªêC') || infoDiv.innerHTML.includes('B·∫ÆT ƒê·∫¶U H√ÄNH TR√åNH');
        let confirmationMsg = "B·∫°n ch·∫Øc ch·∫Øn mu·ªën h·ªßy chuy·∫øn n√†y?";
        if (isAccepted) {
            confirmationMsg = "T√†i x·∫ø ƒë√£ nh·∫≠n cu·ªëc/ƒë√£ ƒë√≥n kh√°ch. Vi·ªác h·ªßy c√≥ th·ªÉ b·ªã t√≠nh ph√≠. B·∫°n ch·∫Øc ch·∫Øn mu·ªën h·ªßy?";
        }

        if (!confirm(confirmationMsg)) return;

        try {
            const rideRef = ref(db, 'rides/' + currentRideId);
            await remove(rideRef); // X√≥a kh·ªèi Firebase

            infoDiv.innerHTML = '<div style="color:var(--danger-color); font-weight: bold; margin-top: 10px;">‚ùå ƒê√É H·ª¶Y CHUY·∫æN.</div>';
            
            // Reset UI
            currentRideId = null;
            requestBtn.disabled = false;
            cancelBtn.style.display = 'none';
            
            if (routingControl) { map.removeControl(routingControl); routingControl = null; lastRouteSummary = null; }

        } catch (e) {
            alert('L·ªói h·ªßy chuy·∫øn: ' + (e.message || e));
        }
    });
  </script>
</body>
</html>
