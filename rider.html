<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Rider ‚Äî ƒê·∫∑t xe</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="style.css" /> 
  <style>
    /* CSS cho icon t√†i x·∫ø v√† Toast */
    .driver-icon {
      background-image: url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path fill="#dc3545" d="M16 0C9.92 0 4.98 4.79 5.04 10.74c.06 5.86 4.98 10.74 10.96 10.74s10.9-4.88 10.96-10.74C27.02 4.79 22.08 0 16 0zm0 14a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/><path fill="#dc3545" d="M15.5 22.06c-5.5.06-9.94 4.56-9.94 10a10.02 10.02 0 0 0 19.88 0c0-5.44-4.44-9.94-9.94-10z"/></svg>');
      background-size: cover;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.4);
    }
  </style>
</head>
<body>
  <div class="map-page-container">
    <div id="map"></div>

    <div id="controlsOverlay" class="overlay-card">
        <h2 style="margin: 0 0 10px 0; font-size: 1.2em; padding: 0; border: none;">ƒê·∫∑t chuy·∫øn</h2>
        
        <label>ƒêi·ªÉm ƒë√≥n 
            <button id="currentLocationBtn" class="current-location-btn">
              [V·ªã tr√≠ hi·ªán t·∫°i]
            </button>
        </label>
        <div class="input-container">
            <input id="from" placeholder="V√≠ d·ª•: 1 Ph·ªë A, Qu·∫≠n B" />
            <ul id="fromList" class="autocomplete-list" style="display:none;"></ul>
        </div>

        <label>ƒêi·ªÉm ƒë·∫øn</label>
        <div class="input-container">
            <input id="to" placeholder="V√≠ d·ª•: 2 Ph·ªë X, Qu·∫≠n Y" />
            <ul id="toList" class="autocomplete-list" style="display:none;"></ul>
        </div>

        <label>Ch·ªçn lo·∫°i xe</label>
        <select id="vehicle">
            <option value="bike">Xe m√°y</option>
            <option value="car">√î t√¥</option>
        </select>

        <div id="info" style="margin: 10px 0; font-size: 0.95em;"></div>

        <div class="row">
            <button id="estimateBtn" class="col btn btn-primary">∆Ø·ªõc t√≠nh & Tuy·∫øn</button>
            <button id="requestBtn" class="col btn btn-success" disabled>G·ªåI XE</button>
        </div>
        <button id="cancelBtn" class="col btn btn-danger" style="display:none; margin-top: 5px;" disabled>H·ª¶Y CHUY·∫æN</button>
    </div>

    <div id="toast-message" style="display:none;"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, push, ref, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // C·∫•u h√¨nh Firebase (Gi·ªØ nguy√™n)
    const firebaseConfig = {
      apiKey: "AIzaSyCUQpfPPlJqLRm9FyryfX2UOa82mUWbJrE",
      authDomain: "robotkitkat6-bee.firebaseapp.com",
      databaseURL: "https://robotkitkat6-bee-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "robotkitkat6-bee",
      storageBucket: "robotkitkat6-bee.firebasestorage.app",
      messagingSenderId: "117130770804",
      appId: "1:117130770804:web:4827cc61a7c99df99549421",
      measurementId: "G-WMKP4GT930"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Map init
    const map = L.map('map').setView([10.762622, 106.660172], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let routingControl = null;
    let lastRouteSummary = null; 
    let lastFromCoords = null; 
    let lastToCoords = null;   
    let currentRideId = null; 

    const infoDiv = document.getElementById('info');
    const requestBtn = document.getElementById('requestBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const toastDiv = document.getElementById('toast-message');
    
    let selectedFromCoord = null;
    let selectedToCoord = null;

    const driverMarkers = {};
    const driverIcon = L.divIcon({
        className: 'driver-icon',
        iconSize: [30, 30],
        iconAnchor: [15, 15],
        popupAnchor: [0, -15]
    });

    const PRICE = { bikePerKm: 6000, carPerKm: 10000, bikeMin: 10000, carMin: 20000 };

    // === S·ª¨A H√ÄM TOAST: Th√™m tham s·ªë sticky (gi·ªØ th√¥ng b√°o) ===
    let currentToastTimeout = null;

    function hideToast() {
        toastDiv.classList.remove('show');
        if (currentToastTimeout) clearTimeout(currentToastTimeout);
        currentToastTimeout = null;
        setTimeout(() => {
            toastDiv.style.display = 'none';
        }, 500);
    }
    
    function showToast(message, duration = 3000, sticky = false) {
        // X√≥a timeout c≈© n·∫øu c√≥ (v√† reset ·∫©n)
        if (currentToastTimeout) {
            clearTimeout(currentToastTimeout);
            currentToastTimeout = null;
            hideToast(); 
        }

        toastDiv.textContent = message;
        toastDiv.style.display = 'block';
        
        // Timeout ng·∫Øn ƒë·ªÉ chuy·ªÉn tr·∫°ng th√°i "show"
        setTimeout(() => {
            toastDiv.classList.add('show');
        }, 50);

        if (!sticky) {
            currentToastTimeout = setTimeout(() => {
                hideToast();
            }, duration);
        }
    }
    // ==================

    // ... (Gi·ªØ nguy√™n logic Geolocation, ReverseGeocode, Autosuggest) ...
    async function reverseGeocode(lat, lng) {
        const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&accept-language=vi`;
        const res = await fetch(url);
        const data = await res.json();
        if (data && data.display_name) {
             return { 
                lat: parseFloat(data.lat), 
                lng: parseFloat(data.lon), 
                display: data.display_name 
            };
        }
        throw new Error('Kh√¥ng t√¨m th·∫•y ƒë·ªãa ch·ªâ cho t·ªça ƒë·ªô n√†y.');
    }
    document.getElementById('currentLocationBtn').addEventListener('click', () => {
        infoDiv.innerHTML = 'ƒêang t√¨m v·ªã tr√≠ hi·ªán t·∫°i...';
        document.getElementById('currentLocationBtn').disabled = true;
        if (!navigator.geolocation) {
            alert('Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ƒê·ªãnh v·ªã.');
            document.getElementById('currentLocationBtn').disabled = false;
            infoDiv.innerHTML = '';
            return;
        }
        navigator.geolocation.getCurrentPosition(async (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            try {
                const result = await reverseGeocode(lat, lng);
                document.getElementById('from').value = result.display;
                selectedFromCoord = { lat, lng };
                infoDiv.innerHTML = `<div style="color:var(--success-color);">ƒê√£ l·∫•y v·ªã tr√≠ hi·ªán t·∫°i: ${result.display.split(',').slice(0, 3).join(',')}</div>`;
            } catch(e) {
                 infoDiv.innerHTML = `<div style="color:var(--danger-color);">L·ªói l·∫•y ƒë·ªãa ch·ªâ: ${e.message}</div>`;
            } finally {
                document.getElementById('currentLocationBtn').disabled = false;
            }
        }, (error) => {
            infoDiv.innerHTML = `<div style="color:var(--danger-color);">L·ªói ƒê·ªãnh v·ªã: ${error.message}</div>`;
            document.getElementById('currentLocationBtn').disabled = false;
        }, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 });
    });

    const debounce = (func, delay) => {
        let timeoutId;
        return function(...args) {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => func.apply(this, args), delay);
        };
    };
    async function geocode(q) {
      const url = 'https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(q) + '&limit=10&countrycodes=vn&accept-language=vi';
      const res = await fetch(url, { headers: { 'Accept-Language': 'vi' } });
      const arr = await res.json();
      if (!arr || !arr.length) throw new Error('Kh√¥ng t√¨m th·∫•y ƒë·ªãa ƒëi·ªÉm: ' + q);
      return { lat: parseFloat(arr[0].lat), lng: parseFloat(arr[0].lon), display: arr[0].display_name };
    }
    async function fetchSuggestions(query, targetList, targetInput) {
        if (query.length < 3) { targetList.style.display = 'none'; return; }
        try {
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&countrycodes=vn&accept-language=vi`;
            const res = await fetch(url);
            const data = await res.json();
            targetList.innerHTML = '';
            if (data.length === 0) { targetList.style.display = 'none'; return; }
            data.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item.display_name;
                li.dataset.lat = item.lat;
                li.dataset.lng = item.lon;
                li.addEventListener('click', () => {
                    targetInput.value = item.display_name;
                    if (targetInput.id === 'from') {
                        selectedFromCoord = { lat: parseFloat(item.lat), lng: parseFloat(item.lon) };
                    } else {
                        selectedToCoord = { lat: parseFloat(item.lat), lng: parseFloat(item.lon) };
                    }
                    targetList.style.display = 'none';
                    if (selectedFromCoord && selectedToCoord) { document.getElementById('estimateBtn').click(); }
                });
                targetList.appendChild(li);
            });
            targetList.style.display = 'block';
        } catch (error) {
            targetList.style.display = 'none';
        }
    }
    const debouncedFromSuggest = debounce((query) => fetchSuggestions(query, document.getElementById('fromList'), document.getElementById('from')), 400);
    const debouncedToSuggest = debounce((query) => fetchSuggestions(query, document.getElementById('toList'), document.getElementById('to')), 400);

    document.getElementById('from').addEventListener('input', (e) => { selectedFromCoord = null; debouncedFromSuggest(e.target.value.trim()); });
    document.getElementById('to').addEventListener('input', (e) => { selectedToCoord = null; debouncedToSuggest(e.target.value.trim()); });
    document.addEventListener('click', (e) => {
        if (!document.getElementById('from').parentElement.contains(e.target)) document.getElementById('fromList').style.display = 'none';
        if (!document.getElementById('to').parentElement.contains(e.target)) document.getElementById('toList').style.display = 'none';
    });
    
    function initDriverListener() {
        const driversRef = ref(db, 'drivers');
        onValue(driversRef, (snapshot) => {
            const drivers = snapshot.val() || {};
            const activeDriverIds = new Set();
            Object.keys(drivers).forEach(driverId => {
                const d = drivers[driverId];
                activeDriverIds.add(driverId);
                if (d.online && d.lat && d.lng) {
                    const latLng = [d.lat, d.lng];
                    const name = d.name || 'T√†i x·∫ø ·∫©n danh';
                    if (driverMarkers[driverId]) {
                        driverMarkers[driverId].setLatLng(latLng);
                        driverMarkers[driverId].setPopupContent(`<b>${name}</b> ƒëang Online`);
                    } else {
                        const marker = L.marker(latLng, { icon: driverIcon }).addTo(map);
                        marker.bindPopup(`<b>${name}</b> ƒëang Online`);
                        driverMarkers[driverId] = marker;
                    }
                }
            });
            Object.keys(driverMarkers).forEach(driverId => {
                if (!activeDriverIds.has(driverId)) {
                    map.removeLayer(driverMarkers[driverId]);
                    delete driverMarkers[driverId];
                }
            });
        });
    }
    initDriverListener();
    // ==========================================================
    
    function showRoute(fromCoords, toCoords) {
      if (routingControl) { map.removeControl(routingControl); routingControl = null; lastRouteSummary = null; }
      routingControl = L.Routing.control({
        waypoints: [
          L.latLng(fromCoords.lat, fromCoords.lng),
          L.latLng(toCoords.lat, toCoords.lng)
        ],
        router: L.Routing.osrmv1({serviceUrl: 'https://router.project-osrm.org/route/v1'}),
        addWaypoints: false,
        draggableWaypoints: false,
        fitSelectedRoutes: true,
        showAlternatives: false,
        lineOptions: { styles: [{ color: '#007bff', weight: 6, opacity: 0.7 }] } 
      }).addTo(map);

      routingControl.on('routesfound', function(e) {
        const route = e.routes[0];
        lastRouteSummary = { distance: route.summary.totalDistance, duration: route.summary.totalTime };
        displayInfo();
        requestBtn.disabled = false;
        lastFromCoords = { lat: e.routes[0].waypoints[0].latLng.lat, lng: e.routes[0].waypoints[0].latLng.lng };
        lastToCoords = { lat: e.routes[0].waypoints[1].latLng.lat, lng: e.routes[0].waypoints[1].latLng.lng };
      });

      routingControl.on('routingerror', function(e) {
         lastRouteSummary = null;
         requestBtn.disabled = true;
         infoDiv.innerHTML = `<div style="color:var(--danger-color);"><b>L·ªói:</b> Kh√¥ng t√¨m th·∫•y tuy·∫øn ƒë∆∞·ªùng.</div>`;
      });
    }

    function displayInfo() {
      if (!lastRouteSummary) return;
      const km = (lastRouteSummary.distance / 1000);
      const mins = Math.round(lastRouteSummary.duration / 60);
      const vehicle = document.getElementById('vehicle').value;
      let priceCalc = 0;
      if (vehicle === 'bike') {
        priceCalc = Math.max(Math.round(km * PRICE.bikePerKm), PRICE.bikeMin);
      } else {
        priceCalc = Math.max(Math.round(km * PRICE.carPerKm), PRICE.carMin);
      }
      infoDiv.innerHTML = `
        <div style="margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px;">
            <div><b>Qu√£ng ƒë∆∞·ªùng:</b> ${km.toFixed(2)} km</div>
            <div><b>Th·ªùi gian:</b> ${mins} ph√∫t</div>
            <div><b>Lo·∫°i xe:</b> ${vehicle === 'bike' ? 'Xe m√°y' : '√î t√¥'}</div>
            <div style="font-size: 1.1em; color: var(--success-color);"><b>Gi√° ∆∞·ªõc t√≠nh:</b> ${priceCalc.toLocaleString()} ƒë</div>
        </div>
      `;
    }
    
    function listenForAcceptance(rideId) {
        const rideRef = ref(db, 'rides/' + rideId);
        onValue(rideRef, (snap) => {
            const ride = snap.val();
            
            if (!ride) {
                 if (currentRideId === rideId) {
                     showToast('Cu·ªëc xe ƒë√£ k·∫øt th√∫c ho·∫∑c b·ªã h·ªßy.', 5000);
                     hideToast(); // ·∫®n ngay sau khi b√°o h·ªßy
                     cancelBtn.style.display = 'none';
                     requestBtn.disabled = false;
                     currentRideId = null;
                 }
                 return;
            }

            const driverName = ride.driverName || 'T√†i x·∫ø';

            if (ride.status === 'accepted') {
                // Khi ƒë∆∞·ª£c nh·∫≠n, th√¥ng b√°o ng·∫Øn v√† t·ª± ƒë·ªông ·∫©n (sticky=false)
                showToast(`‚úÖ T√†i x·∫ø ${driverName.split('-')[0].trim()} ƒë√£ nh·∫≠n cu·ªëc! ƒêang ƒë·∫øn ƒë√≥n b·∫°n.`, 8000, false);
                infoDiv.innerHTML = `<div style="color:var(--primary-color);">T√†i x·∫ø <b>${driverName}</b> ƒëang ƒë·∫øn ƒë√≥n b·∫°n.</div>`;
            } else if (ride.status === 'onTrip') {
                // Khi b·∫Øt ƒë·∫ßu chuy·∫øn ƒëi, th√¥ng b√°o ng·∫Øn v√† t·ª± ƒë·ªông ·∫©n (sticky=false)
                showToast(`üöó B·∫Øt ƒë·∫ßu h√†nh tr√¨nh c√πng T√†i x·∫ø ${driverName.split('-')[0].trim()}!`, 8000, false);
                infoDiv.innerHTML = `<div style="color:var(--success-color);">B·∫°n ƒëang tr√™n ƒë∆∞·ªùng ƒë·∫øn ƒëi·ªÉm ƒë·∫øn.</div>`;
            } else if (ride.status === 'finding') {
                // ƒêANG T√åM T√ÄI X·∫æ: S·ª¨ D·ª§NG STICKY = TRUE
                showToast('üîç ƒêang t√¨m t√†i x·∫ø g·∫ßn b·∫°n...', 0, true); 
                infoDiv.innerHTML = `<div style="color:var(--secondary-color);">Y√™u c·∫ßu ƒë√£ g·ª≠i (ID: ${rideId.slice(-4)}). ƒêang t√¨m t√†i x·∫ø...</div>`;
            }
            
            if (ride.status !== 'completed' && ride.status !== 'canceled') {
                cancelBtn.style.display = 'block';
                cancelBtn.disabled = false;
            } else {
                 hideToast(); // ·∫®n toast n·∫øu tr·∫°ng th√°i l√† ho√†n th√†nh/h·ªßy
            }

        });
    }

    document.getElementById('estimateBtn').addEventListener('click', async () => {
      const from = document.getElementById('from').value.trim();
      const to = document.getElementById('to').value.trim();
      if (!from || !to) return alert('Nh·∫≠p ƒëi·ªÉm ƒë√≥n v√† ƒëi·ªÉm ƒë·∫øn');
      
      try {
        document.getElementById('estimateBtn').disabled = true;
        requestBtn.disabled = true;
        infoDiv.innerHTML = '<div style="color:var(--secondary-color);">ƒêang t√¨m ƒë·ªãa ch·ªâ...</div>';
        cancelBtn.style.display = 'none';
        hideToast(); // ƒê·∫£m b·∫£o ·∫©n toast c≈© n·∫øu c√≥

        let fromCoords, toCoords;

        if (selectedFromCoord) {
            fromCoords = selectedFromCoord;
        } else {
             fromCoords = await geocode(from);
        }
        
        if (selectedToCoord) {
            toCoords = selectedToCoord;
        } else {
             toCoords = await geocode(to);
        }

        showRoute(fromCoords, toCoords);

      } catch (e) {
        alert(e.message || 'L·ªói khi geocode/t√¨m tuy·∫øn ƒë∆∞·ªùng');
        infoDiv.innerHTML = '';
        lastRouteSummary = null;
        lastFromCoords = null;
        lastToCoords = null;
      } finally {
        document.getElementById('estimateBtn').disabled = false;
      }
    });

    requestBtn.addEventListener('click', async () => {
      if (!lastRouteSummary || !lastFromCoords || !lastToCoords) {
        return alert('Vui l√≤ng nh·∫•n "∆Ø·ªõc t√≠nh & Hi·ªÉn th·ªã tuy·∫øn" tr∆∞·ªõc v√† ƒë·∫£m b·∫£o t√¨m th·∫•y tuy·∫øn ƒë∆∞·ªùng.');
      }
      
      const from = document.getElementById('from').value.trim();
      const to = document.getElementById('to').value.trim();
      const vehicle = document.getElementById('vehicle').value;
      const km = lastRouteSummary.distance / 1000;
      
      let fare = 0;
      if (vehicle === 'bike') fare = Math.max(Math.round(km * PRICE.bikePerKm), PRICE.bikeMin);
      else fare = Math.max(Math.round(km * PRICE.carPerKm), PRICE.carMin);

      const ride = {
        createdAt: Date.now(),
        status: 'finding',
        fromText: from,
        toText: to,
        from: lastFromCoords, 
        to: lastToCoords, 
        distance_m: lastRouteSummary.distance,
        duration_s: lastRouteSummary.duration,
        fare: fare,
        vehicle: vehicle
      };

      try {
        const ridesRef = ref(db, 'rides');
        const newRef = await push(ridesRef, ride);
        const rideId = newRef.key;

        currentRideId = rideId; 
        listenForAcceptance(rideId);
        
        requestBtn.disabled = true;
        // B·ªè showToast ·ªü ƒë√¢y v√¨ listenForAcceptance ƒë√£ ƒë·∫£m nh·∫≠n vi·ªác hi·ªÉn th·ªã STICKY toast

      } catch (e) {
        alert('L·ªói g·ª≠i y√™u c·∫ßu: ' + (e.message || e));
      }
    });

    cancelBtn.addEventListener('click', async () => {
        if (!currentRideId) return;

        const isAccepted = infoDiv.innerHTML.includes('T√†i x·∫ø') || infoDiv.innerHTML.includes('B·∫Øt ƒë·∫ßu h√†nh tr√¨nh');
        let confirmationMsg = "B·∫°n ch·∫Øc ch·∫Øn mu·ªën h·ªßy chuy·∫øn n√†y?";
        if (isAccepted) {
            confirmationMsg = "T√†i x·∫ø ƒë√£ nh·∫≠n cu·ªëc. B·∫°n ch·∫Øc ch·∫Øn mu·ªën h·ªßy?";
        }

        if (!confirm(confirmationMsg)) return;

        try {
            const rideRef = ref(db, 'rides/' + currentRideId);
            await remove(rideRef); 

            showToast('‚ùå ƒê√£ h·ªßy chuy·∫øn th√†nh c√¥ng.', 5000);
            
            currentRideId = null;
            requestBtn.disabled = false;
            cancelBtn.style.display = 'none';
            infoDiv.innerHTML = '';
            
            if (routingControl) { map.removeControl(routingControl); routingControl = null; lastRouteSummary = null; }

        } catch (e) {
            alert('L·ªói h·ªßy chuy·∫øn: ' + (e.message || e));
        }
    });
  </script>
</body>
</html>
