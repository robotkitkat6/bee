<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Rider — Đặt xe</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="style.css" /> </head>
<body>
  <h2>Đặt xe — Nhập địa chỉ</h2>

  <label>Điểm đón</label>
  <input id="from" placeholder="Ví dụ: 1 Phố A, Quận B" />

  <label>Điểm đến</label>
  <input id="to" placeholder="Ví dụ: 2 Phố X, Quận Y" />

  <label>Chọn loại xe</label>
  <select id="vehicle">
    <option value="bike">Xe máy</option>
    <option value="car">Ô tô</option>
  </select>

  <div class="row">
    <button id="estimateBtn" class="col btn btn-primary">Ước tính & Hiển thị tuyến</button>
    <button id="requestBtn" class="col btn btn-secondary" disabled>Gọi xe (lưu)</button>
    <button id="cancelBtn" class="col btn btn-danger" style="display:none;" disabled>Hủy chuyến</button>
  </div>
  <div id="info"></div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, push, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // Cấu hình Firebase (Đã đồng bộ)
    const firebaseConfig = {
      apiKey: "AIzaSyCUQpfPPlJqLRm9FyryfX2UOa82mUWbJrE",
      authDomain: "robotkitkat6-bee.firebaseapp.com",
      databaseURL: "https://robotkitkat6-bee-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "robotkitkat6-bee",
      storageBucket: "robotkitkat6-bee.firebasestorage.app",
      messagingSenderId: "117130770804",
      appId: "1:117130770804:web:4827cc61a7c9df99549421",
      measurementId: "G-WMKP4GT930"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Map init
    const map = L.map('map').setView([10.762622, 106.660172], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let routingControl = null;
    let lastRouteSummary = null; // {distance (m), duration (s)}
    let lastFromCoords = null; 
    let lastToCoords = null;   
    let currentRideId = null; // BIẾN MỚI: Theo dõi ID chuyến đi hiện tại

    const infoDiv = document.getElementById('info');
    const estimateBtn = document.getElementById('estimateBtn');
    const requestBtn = document.getElementById('requestBtn');
    const cancelBtn = document.getElementById('cancelBtn'); // NÚT MỚI

    // Pricing
    const PRICE = { bikePerKm: 6000, carPerKm: 10000, bikeMin: 10000, carMin: 20000 };

    // Geocode via Nominatim
    async function geocode(q) {
      const url = 'https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(q);
      const res = await fetch(url, { headers: { 'Accept-Language': 'vi' } });
      const arr = await res.json();
      if (!arr || !arr.length) throw new Error('Không tìm thấy địa điểm: ' + q);
      return { lat: parseFloat(arr[0].lat), lng: parseFloat(arr[0].lon), display: arr[0].display_name };
    }

    // Estimate route using Leaflet Routing Machine (OSRM public)
    function showRoute(fromCoords, toCoords) {
      if (routingControl) { map.removeControl(routingControl); routingControl = null; lastRouteSummary = null; }
      routingControl = L.Routing.control({
        waypoints: [
          L.latLng(fromCoords.lat, fromCoords.lng),
          L.latLng(toCoords.lat, toCoords.lng)
        ],
        router: L.Routing.osrmv1({serviceUrl: 'https://router.project-osrm.org/route/v1'}),
        addWaypoints: false,
        draggableWaypoints: false,
        fitSelectedRoutes: true,
        showAlternatives: false
      }).addTo(map);

      routingControl.on('routesfound', function(e) {
        const route = e.routes[0];
        lastRouteSummary = { distance: route.summary.totalDistance, duration: route.summary.totalTime };
        displayInfo();
        requestBtn.disabled = false;
      });

      routingControl.on('routingerror', function(e) {
         lastRouteSummary = null;
         requestBtn.disabled = true;
         infoDiv.innerHTML = `<div><b>Lỗi:</b> Không tìm thấy tuyến đường.</div>`;
      });
    }

    function displayInfo() {
      if (!lastRouteSummary) return;
      const km = (lastRouteSummary.distance / 1000);
      const mins = Math.round(lastRouteSummary.duration / 60);
      const vehicle = document.getElementById('vehicle').value;
      let priceCalc = 0;
      if (vehicle === 'bike') {
        priceCalc = Math.max(Math.round(km * PRICE.bikePerKm), PRICE.bikeMin);
      } else {
        priceCalc = Math.max(Math.round(km * PRICE.carPerKm), PRICE.carMin);
      }
      infoDiv.innerHTML = `
        <div><b>Khoảng cách:</b> ${km.toFixed(2)} km</div>
        <div><b>Thời gian dự kiến:</b> ${mins} phút</div>
        <div><b>Loại xe:</b> ${vehicle === 'bike' ? 'Xe máy' : 'Ô tô'}</div>
        <div><b>Giá ước tính:</b> ${priceCalc.toLocaleString()} đ</div>
      `;
    }
    
    // HÀM LẮNG NGHE TRẠNG THÁI CUỐC XE
    function listenForAcceptance(rideId) {
        const rideRef = ref(db, 'rides/' + rideId);
        onValue(rideRef, (snap) => {
            const ride = snap.val();
            
            if (!ride) {
                 // Cuốc xe đã bị hủy (bởi rider/driver) hoặc hoàn thành
                 if (currentRideId === rideId) {
                     infoDiv.innerHTML = infoDiv.innerHTML.includes('✅') ? infoDiv.innerHTML : `<div style="color:var(--secondary-color); margin-top: 10px;">Cuốc xe đã kết thúc.</div>`;
                     cancelBtn.style.display = 'none';
                     requestBtn.disabled = false;
                     currentRideId = null;
                 }
                 return;
            }

            if (ride.status === 'accepted') {
                const driverName = ride.driverName || 'Tài xế';
                infoDiv.innerHTML = `
                    <div style="color:var(--primary-color); font-weight: bold; font-size: 1.2em;">✅ TÀI XẾ ĐÃ NHẬN CUỐC!</div>
                    <div>Tài xế <b>${driverName}</b> đang đến đón bạn.</div>
                `;
            } else if (ride.status === 'finding') {
                if (!infoDiv.innerHTML.includes('Đang tìm tài xế')) {
                    infoDiv.innerHTML += `<div style="color:var(--success-color); margin-top: 10px;">Yêu cầu đã gửi (ID: ${rideId}). Đang tìm tài xế...</div>`;
                }
            }
        });
    }

    // Button: Estimate (Giữ nguyên)
    estimateBtn.addEventListener('click', async () => {
      // Logic Geocode...
      const from = document.getElementById('from').value.trim();
      const to = document.getElementById('to').value.trim();
      if (!from || !to) return alert('Nhập điểm đón và điểm đến');
      try {
        estimateBtn.disabled = true;
        requestBtn.disabled = true;
        infoDiv.innerHTML = 'Đang tìm địa chỉ...';
        
        // ẨN NÚT HỦY KHI ƯỚC TÍNH LẠI
        cancelBtn.style.display = 'none';

        const fromCoords = await geocode(from);
        const toCoords = await geocode(to);

        lastFromCoords = fromCoords;
        lastToCoords = toCoords;

        showRoute(fromCoords, toCoords);
      } catch (e) {
        alert(e.message || 'Lỗi khi geocode');
        infoDiv.innerHTML = '';
        lastRouteSummary = null;
        lastFromCoords = null;
        lastToCoords = null;
      } finally {
        estimateBtn.disabled = false;
      }
    });

    // Button: Request (Đã sửa)
    requestBtn.addEventListener('click', async () => {
      if (!lastRouteSummary || !lastFromCoords || !lastToCoords) {
        return alert('Vui lòng nhấn "Ước tính & Hiển thị tuyến" trước và đảm bảo tìm thấy tuyến đường.');
      }
      
      const from = document.getElementById('from').value.trim();
      const to = document.getElementById('to').value.trim();
      const vehicle = document.getElementById('vehicle').value;
      const km = lastRouteSummary.distance / 1000;
      const mins = Math.round(lastRouteSummary.duration / 60);

      let fare = 0;
      if (vehicle === 'bike') fare = Math.max(Math.round(km * PRICE.bikePerKm), PRICE.bikeMin);
      else fare = Math.max(Math.round(km * PRICE.carPerKm), PRICE.carMin);

      const ride = {
        createdAt: Date.now(),
        status: 'finding',
        fromText: from,
        toText: to,
        from: { lat: lastFromCoords.lat, lng: lastFromCoords.lng },
        to: { lat: lastToCoords.lat, lng: lastToCoords.lng },
        distance_m: lastRouteSummary.distance,
        duration_s: lastRouteSummary.duration,
        distance_km: km,
        duration_min: mins,
        fare: fare,
        vehicle: vehicle
      };

      try {
        const ridesRef = ref(db, 'rides');
        const newRef = await push(ridesRef, ride);
        const rideId = newRef.key;

        currentRideId = rideId; // LƯU ID CUỐC XE
        listenForAcceptance(rideId);
        
        requestBtn.disabled = true;

        // HIỂN THỊ NÚT HỦY CHUYẾN
        cancelBtn.style.display = 'inline-block';
        cancelBtn.disabled = false;
      } catch (e) {
        alert('Lỗi gửi yêu cầu: ' + (e.message || e));
      }
    });

    // NÚT MỚI: HỦY CHUYẾN (RIDER)
    cancelBtn.addEventListener('click', async () => {
        if (!currentRideId) return;

        if (!confirm("Bạn chắc chắn muốn hủy chuyến này? Việc hủy có thể bị tính phí nếu tài xế đã nhận cuốc.")) return;

        try {
            const rideRef = ref(db, 'rides/' + currentRideId);
            await remove(rideRef); // Xóa khỏi Firebase

            infoDiv.innerHTML = '<div style="color:var(--danger-color); font-weight: bold; margin-top: 10px;">❌ ĐÃ HỦY CHUYẾN.</div>';
            
            // Reset UI
            currentRideId = null;
            requestBtn.disabled = false;
            cancelBtn.style.display = 'none';
            
            if (routingControl) { map.removeControl(routingControl); routingControl = null; lastRouteSummary = null; }

        } catch (e) {
            alert('Lỗi hủy chuyến: ' + (e.message || e));
        }
    });
    // KẾT THÚC NÚT HỦY CHUYẾN
  </script>
</body>
</html>
