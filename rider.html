<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Rider — Đặt xe</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    /* Biến màu */
    :root {
        --primary-color: #007bff; /* Blue */
        --success-color: #28a745; /* Green */
        --danger-color: #dc3545; /* Red */
    }

    body{
        font-family:Arial;
        margin:0;
        padding:12px;
        /* Thêm padding dưới để tránh nội dung bị che bởi Overlay */
        padding-bottom: 120px; 
    }
    #map{
        height:50vh;
        margin-top:8px;
    }
    input, select, button{
        padding:8px;
        margin:6px 0;
        width:100%;
        box-sizing:border-box;
        border-radius: 6px;
        border: 1px solid #ccc;
    }
    button {
        cursor: pointer;
        font-weight: bold;
    }
    #estimateBtn { background-color: #f8f9fa; }
    #requestBtn { background-color: var(--primary-color); color: white; }
    
    .row{display:flex;gap:8px}
    .col{flex:1}

    /* === 1. Bảng Điều khiển Trạng thái Cuốc xe (Overlay) - Giữ nguyên vị trí cố định dưới cùng === */
    #rideStatusOverlay {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        max-height: 90vh;
        background-color: white;
        border-top-left-radius: 15px;
        border-top-right-radius: 15px;
        box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.2);
        padding: 15px;
        transition: transform 0.3s ease-out;
        z-index: 500;
        overflow-y: auto;
        box-sizing: border-box;
        display: none; /* Mặc định ẩn, chỉ hiện khi gọi xe */
    }

    /* Chế độ thu nhỏ */
    #rideStatusOverlay.default-view {
        transform: translateY(calc(100% - 120px)); 
    }
    /* Chế độ mở rộng */
    #rideStatusOverlay.expanded-view {
        transform: translateY(0);
    }
    /* Các style phụ cho Overlay */
    #statusTitle {
        font-weight: bold;
        color: var(--primary-color);
        text-align: center;
        margin-bottom: 10px;
        cursor: pointer; 
    }
    .status-finding { color: orange; }
    .status-accepted { color: var(--success-color); }
    .status-completed { color: #333; }
    .status-canceled { color: var(--danger-color); }

    /* === 2. Style cho Suggestion List (Autocomplete) === */
    .suggestions-container {
        position: relative;
    }
    .suggestions-list {
        position: absolute;
        top: 100%; 
        left: 0;
        width: 100%;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #ccc;
        border-top: none;
        background-color: white;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 1000;
    }
    .suggestion-item {
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
        font-size: 0.9em;
    }
    .suggestion-item:hover {
        background-color: #f0f0f0;
    }
  </style>
</head>
<body>
  
  <div id="inputControlPanel">
      <h2>Đặt xe — Nhập địa chỉ</h2>

      <label>Điểm đón</label>
      <div class="suggestions-container">
        <input id="from" placeholder="Ví dụ: 1 Phố A, Quận B" />
        <div id="fromSuggestions" class="suggestions-list"></div> 
      </div>

      <label>Điểm đến</label>
      <div class="suggestions-container">
        <input id="to" placeholder="Ví dụ: 2 Phố X, Quận Y" />
        <div id="toSuggestions" class="suggestions-list"></div> 
      </div>

      <label>Chọn loại xe</label>
      <select id="vehicle">
        <option value="bike">Xe máy</option>
        <option value="car">Ô tô</option>
      </select>

      <div class="row">
        <button id="estimateBtn" class="col">Ước tính & Hiển thị tuyến</button>
        <button id="requestBtn" class="col" disabled>Gọi xe (lưu)</button>
      </div>

      <div id="info"></div>
  </div>


  <div id="map"></div>

  <div id="rideStatusOverlay">
      <div id="statusTitle">TRẠNG THÁI CUỐC XE</div>
      <div id="rideStatusContent">
          </div>
      <div style="margin-top: 15px;">
          <button id="cancelRideBtn" style="background-color: var(--danger-color); color: white; display: none;">
              HỦY CUỐC XE
          </button>
      </div>
  </div>


  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.min.js"></script>
  <script src="https://unpkg.com/leaflet-markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { 
        getDatabase, push, ref, onValue, remove, update
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // ====== Cấu hình Firebase ======
    const firebaseConfig = {
      apiKey: "AIzaSyCUQpfPPlJqLRm9FyryfX2UOa82mUWbJrE",
      authDomain: "robotkitkat6-bee.firebaseapp.com",
      databaseURL: "https://robotkitkat6-bee-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "robotkitkat6-bee",
      storageBucket: "robotkitkat6-bee.firebasestorage.app",
      messagingSenderId: "117130770804",
      appId: "1:117130770804:web:4827cc61a7c9df99549421",
      measurementId: "G-WMKP4GT930"
    };
    // =============================================

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Map init
    const map = L.map('map').setView([10.762622, 106.660172], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let routingControl = null;
    let lastRouteSummary = null; // {distance (m), duration (s)}
    let currentRideId = null;
    let driverMarker = null;

    // Biến mới cho vị trí người đặt xe
    let riderCurrentMarker = null;
    let riderCurrentPos = null; // {lat, lng, display}

    // Elements
    const infoDiv = document.getElementById('info');
    const estimateBtn = document.getElementById('estimateBtn');
    const requestBtn = document.getElementById('requestBtn');
    const rideStatusOverlay = document.getElementById('rideStatusOverlay');
    const statusTitle = document.getElementById('statusTitle');
    const rideStatusContent = document.getElementById('rideStatusContent');
    const cancelRideBtn = document.getElementById('cancelRideBtn');
    const inputControlPanel = document.getElementById('inputControlPanel'); // NEW

    const fromInput = document.getElementById('from');
    const toInput = document.getElementById('to');
    const fromSuggestions = document.getElementById('fromSuggestions');
    const toSuggestions = document.getElementById('toSuggestions');
    
    // Pricing
    const PRICE = { bikePerKm: 6000, carPerKm: 10000, bikeMin: 10000, carMin: 20000 };

    // === HÀM QUẢN LÝ GIAO DIỆN CHÍNH (INPUT vs STATUS) ===
    function setInputControlsActive(isActive) {
        inputControlPanel.style.display = isActive ? 'block' : 'none';
        rideStatusOverlay.style.display = isActive ? 'none' : 'block';
        
        if (isActive) {
            // Dọn dẹp bản đồ khi quay lại màn hình nhập liệu
            if (routingControl) { map.removeControl(routingControl); routingControl = null; lastRouteSummary = null; }
            if (driverMarker) { map.removeLayer(driverMarker); driverMarker = null; }
            // Tái căn giữa bản đồ
            map.setView([10.762622, 106.660172], 13); 
            // Vô hiệu hóa nút Gọi xe
            requestBtn.disabled = true;
            infoDiv.innerHTML = '';
            // Gọi lại định vị để đề xuất vị trí hiện tại
            getCurrentLocationAndInitMap();
        } else {
            // Mở rộng overlay khi có cuốc xe
            toggleControlOverlay('expanded');
        }
    }

    // Hàm Utility: Hiển thị/Ẩn Control Overlay
    function toggleControlOverlay(state = 'default') {
        rideStatusOverlay.classList.remove('default-view', 'expanded-view');
        if (state === 'default') {
            rideStatusOverlay.classList.add('default-view');
        } else if (state === 'expanded') {
            rideStatusOverlay.classList.add('expanded-view');
        }
    }
    
    // Sự kiện mở rộng/thu nhỏ Overlay
    statusTitle.addEventListener('click', () => {
        if (rideStatusOverlay.classList.contains('default-view')) {
            toggleControlOverlay('expanded');
        } else {
            toggleControlOverlay('default');
        }
    });
    
    // Sự kiện click ra Map để thu nhỏ Overlay
    map.on('click', () => {
        if (rideStatusOverlay.classList.contains('expanded-view')) {
            toggleControlOverlay('default');
        }
    });

    // Hàm Debounce để giới hạn số lần gọi API
    function debounce(func, delay) {
      let timeoutId;
      return function(...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => func.apply(this, args), delay);
      };
    }

    // --- CHỨC NĂNG GEOCODING (TÌM KIẾM ĐỊA CHỈ) ---
    async function geocode(q) {
      const url = 'https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(q) + '&limit=1';
      const res = await fetch(url, { headers: { 'Accept-Language': 'vi' } });
      const arr = await res.json();
      if (!arr || !arr.length) throw new Error('Không tìm thấy địa điểm: ' + q);
      return { lat: parseFloat(arr[0].lat), lng: parseFloat(arr[0].lon), display: arr[0].display_name, rawData: arr[0] };
    }

    async function fetchSuggestions(query, targetInput, targetList) {
        targetList.innerHTML = '';
        if (query.length < 3) return;

        const url = 'https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(query) + '&limit=5';
        try {
            const res = await fetch(url, { headers: { 'Accept-Language': 'vi' } });
            const arr = await res.json();
            
            if (arr && arr.length > 0) {
                arr.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.innerHTML = item.display_name;
                    div.onclick = () => {
                        targetInput.value = item.display_name;
                        targetList.innerHTML = ''; // Xóa danh sách gợi ý
                    };
                    targetList.appendChild(div);
                });
            }
        } catch (e) {
            console.error("Lỗi tìm kiếm gợi ý:", e);
        }
    }

    fromInput.oninput = debounce(() => fetchSuggestions(fromInput.value, fromInput, fromSuggestions), 500);
    toInput.oninput = debounce(() => fetchSuggestions(toInput.value, toInput, toSuggestions), 500);

    // Ẩn gợi ý khi click ra ngoài
    document.addEventListener('click', (e) => {
        if (e.target.id !== 'from' && e.target.id !== 'to') {
            fromSuggestions.innerHTML = '';
            toSuggestions.innerHTML = '';
        }
    });
    // --- KẾT THÚC CHỨC NĂNG GEOCODING ---

    // Reverse Geocode via Nominatim
    async function reverseGeocode(lat, lng) {
      const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&countrycodes=vn`; 
      const res = await fetch(url, { headers: { 'Accept-Language': 'vi' } });
      const data = await res.json();
      if (data && data.display_name) {
        return data.display_name;
      }
      return `Vị trí (${lat.toFixed(4)}, ${lng.toFixed(4)})`;
    }

    // Get current location, update map, and fill 'from' input
    function getCurrentLocationAndInitMap() {
        if (!navigator.geolocation) {
            infoDiv.innerHTML = `<div style="color:var(--danger-color);">Trình duyệt không hỗ trợ định vị. Vui lòng nhập địa chỉ.</div>`;
            return;
        }

        infoDiv.innerHTML = `<div style="color:var(--primary-color);">Đang tìm vị trí hiện tại...</div>`;

        // Attempt to get high accuracy position
        navigator.geolocation.getCurrentPosition(async (pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            riderCurrentPos = { lat, lng };

            // Center map and add marker
            map.setView([lat, lng], 16);
            if (riderCurrentMarker) map.removeLayer(riderCurrentMarker); 
            riderCurrentMarker = L.marker([lat, lng]).addTo(map);
            riderCurrentMarker.bindPopup("Vị trí của bạn").openPopup();

            // Reverse Geocode to fill 'from' input
            try {
                const addressText = await reverseGeocode(lat, lng);
                riderCurrentPos.display = addressText;
                document.getElementById('from').value = addressText; 
                infoDiv.innerHTML = `<div style="color:var(--success-color);">✅ Đã tìm thấy vị trí hiện tại: ${addressText.split(',').slice(0, 2).join(',')}</div>`;
            } catch (e) {
                console.error("Lỗi reverse geocode:", e);
                document.getElementById('from').value = `(${lat.toFixed(6)}, ${lng.toFixed(6)})`;
            }

        }, (err) => {
            console.warn(`Lỗi định vị: ${err.code} - ${err.message}`);
            infoDiv.innerHTML = `<div style="color:var(--danger-color);">
                ❌ **Lỗi định vị:** Không lấy được vị trí hiện tại (${err.code}).
                Vui lòng kiểm tra đã cấp quyền **Vị trí** cho trình duyệt (thường ở góc trên bên trái thanh địa chỉ).
                Vẫn có thể nhập địa chỉ thủ công.
            </div>`;
        }, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 });
    }


    // Estimate route using Leaflet Routing Machine (OSRM public)
    function showRoute(fromCoords, toCoords) {
      if (routingControl) { map.removeControl(routingControl); routingControl = null; lastRouteSummary = null; }
      routingControl = L.Routing.control({
        waypoints: [
          L.latLng(fromCoords.lat, fromCoords.lng),
          L.latLng(toCoords.lat, toCoords.lng)
        ],
        router: L.Routing.osrmv1({serviceUrl: 'https://router.project-osrm.org/route/v1'}),
        addWaypoints: false,
        draggableWaypoints: false,
        fitSelectedRoutes: true,
        showAlternatives: false,
        createMarker: function(i, wp, n) {
            let iconUrl = (i === 0) ? 
                'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png' : 
                'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png'; 
            
            return L.marker(wp.latLng, { 
                draggable: false, 
                icon: L.icon({
                    iconUrl: iconUrl,
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
                }) 
            });
        }
      }).addTo(map);

      routingControl.on('routesfound', function(e) {
        const route = e.routes[0];
        lastRouteSummary = { distance: route.summary.totalDistance, duration: route.summary.totalTime };
        displayInfo();
        requestBtn.disabled = false;
      });
      // Bắt lỗi khi không tìm thấy tuyến đường 
      routingControl.on('routingerror', function(e) {
        alert('Lỗi tìm tuyến đường: Không thể kết nối các điểm đã chọn.');
        requestBtn.disabled = true;
      });
    }

    function displayInfo() {
      if (!lastRouteSummary) return;
      const km = (lastRouteSummary.distance / 1000);
      const mins = Math.round(lastRouteSummary.duration / 60);
      const vehicle = document.getElementById('vehicle').value;
      let priceCalc = 0;
      if (vehicle === 'bike') {
        priceCalc = Math.max(Math.round(km * PRICE.bikePerKm), PRICE.bikeMin);
      } else {
        priceCalc = Math.max(Math.round(km * PRICE.carPerKm), PRICE.carMin);
      }
      infoDiv.innerHTML = `
        <div><b>Khoảng cách:</b> ${km.toFixed(2)} km</div>
        <div><b>Thời gian dự kiến:</b> ${mins} phút</div>
        <div><b>Loại xe:</b> ${vehicle === 'bike' ? 'Xe máy' : 'Ô tô'}</div>
        <div><b>Giá ước tính:</b> ${priceCalc.toLocaleString()} đ</div>
      `;
    }

    // === HÀM CẬP NHẬT TRẠNG THÁI CUỐC XE ===
    function updateRideStatusUI(ride) {
        // Overlay đã được hiển thị bằng setInputControlsActive(false)
        let titleText = `Cuốc xe #${currentRideId.slice(-4)}`;
        let contentHTML = '';
        let showCancel = true;
        
        statusTitle.classList.remove('status-finding', 'status-accepted', 'status-completed', 'status-canceled');

        switch (ride.status) {
            case 'finding':
                titleText = 'Đang tìm tài xế...';
                statusTitle.classList.add('status-finding');
                contentHTML = `
                    <p style="text-align:center; font-weight:bold; color:orange;">Đang gửi yêu cầu đến các tài xế gần bạn.</p>
                    <p>Vui lòng chờ chấp nhận. Thông tin tài xế sẽ hiển thị khi có người nhận cuốc.</p>
                `;
                break;
            case 'accepted':
                titleText = `Tài xế ${ride.driverName.split('-')[0].trim()} đã nhận cuốc!`;
                statusTitle.classList.add('status-accepted');
                contentHTML = `
                    <p><b>Tài xế:</b> ${ride.driverName}</p>
                    <p><b>Trạng thái:</b> Tài xế đang trên đường đến điểm đón của bạn.</p>
                `;
                break;
            case 'onTrip':
                titleText = 'Đang trên đường đi';
                statusTitle.classList.add('status-accepted');
                contentHTML = `
                    <p><b>Tài xế:</b> ${ride.driverName}</p>
                    <p><b>Trạng thái:</b> Đã đón khách, đang di chuyển đến điểm đến.</p>
                    <p>Chúc bạn có một chuyến đi vui vẻ!</p>
                `;
                break;
            case 'completed':
                titleText = 'Cuốc xe hoàn thành!';
                statusTitle.classList.add('status-completed');
                contentHTML = `
                    <p style="text-align:center; font-weight:bold; color:var(--success-color);">Cảm ơn bạn đã sử dụng dịch vụ!</p>
                    <p>Tổng tiền: ${ride.fare ? ride.fare.toLocaleString() + ' đ' : '—'}</p>
                `;
                showCancel = false;
                break;
            case 'canceled':
                titleText = 'Cuốc xe đã bị HỦY';
                statusTitle.classList.add('status-canceled');
                contentHTML = `<p style="text-align:center; font-weight:bold; color:var(--danger-color);">Cuốc xe đã bị hủy bởi bạn hoặc tài xế.</p>`;
                showCancel = false;
                break;
            default:
                titleText = 'Lỗi trạng thái';
                showCancel = false;
        }

        statusTitle.innerHTML = titleText;
        rideStatusContent.innerHTML = contentHTML;
        cancelRideBtn.style.display = showCancel ? 'block' : 'none';

        // Cập nhật vị trí tài xế trên bản đồ
        if (ride.driverLat && ride.driverLng) {
            const driverCoords = L.latLng(ride.driverLat, ride.driverLng);
            if (!driverMarker) {
                driverMarker = L.marker(driverCoords, { icon: L.icon({
                    iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
                }) }).addTo(map);
                driverMarker.bindPopup("Tài xế của bạn").openPopup();
            } else {
                driverMarker.setLatLng(driverCoords);
            }
        } else if (driverMarker) {
            map.removeLayer(driverMarker);
            driverMarker = null;
        }
        
        // Cập nhật chế độ xem bản đồ để tập trung vào tài xế và điểm đón nếu đã Accepted
        if (ride.status === 'accepted' || ride.status === 'onTrip') {
            const riderCoords = riderCurrentMarker ? riderCurrentMarker.getLatLng() : L.latLng(ride.from.lat, ride.from.lng);
            if(driverMarker) {
                const driverCoords = driverMarker.getLatLng();
                const bounds = L.latLngBounds(riderCoords, driverCoords);
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }
    }
    
    // === HÀM LẮNG NGHE TRẠNG THÁI CUỐC XE ===
    function listenToRide(rideId) {
        currentRideId = rideId;
        const rideRef = ref(db, 'rides/' + rideId);
        
        onValue(rideRef, (snapshot) => {
            const ride = snapshot.val();
            if (ride) {
                updateRideStatusUI(ride);
                if (ride.status === 'completed' || ride.status === 'canceled') {
                    setTimeout(() => {
                        setInputControlsActive(true); // QUAY LẠI MÀN HÌNH NHẬP LIỆU
                        currentRideId = null;
                    }, 5000);
                }
            } else {
                // Xóa khỏi DB
                updateRideStatusUI({ status: 'canceled', fare: 0 });
                setTimeout(() => {
                    setInputControlsActive(true); // QUAY LẠI MÀN HÌNH NHẬP LIỆU
                    currentRideId = null;
                }, 5000);
            }
        });
        
        cancelRideBtn.onclick = () => cancelRide(rideId);
    }
    
    // === HÀM HỦY CUỐC XE ===
    async function cancelRide(rideId) {
        if (!confirm("Bạn chắc chắn muốn hủy cuốc xe này?")) return;
        try {
            const rideRef = ref(db, 'rides/' + rideId);
            await update(rideRef, { status: 'canceled', canceledBy: 'rider', canceledAt: Date.now() });
            await remove(rideRef);
            alert("Cuốc xe đã được hủy.");
        } catch (e) {
            alert('Lỗi hủy cuốc: ' + (e.message || e));
        }
    }

    // Button: Estimate
    estimateBtn.addEventListener('click', async () => {
      const from = document.getElementById('from').value.trim();
      const to = document.getElementById('to').value.trim();
      if (!from || !to) return alert('Nhập điểm đón và điểm đến');
      
      fromSuggestions.innerHTML = '';
      toSuggestions.innerHTML = '';

      try {
        if (currentRideId) return alert("Bạn đang có cuốc xe đang hoạt động!");
        estimateBtn.disabled = true;
        infoDiv.innerHTML = 'Đang tìm địa chỉ...';
        
        const fromCoords = await geocode(from);
        const toCoords = await geocode(to);
        
        document.getElementById('from').value = fromCoords.display;
        document.getElementById('to').value = toCoords.display;
        
        showRoute(fromCoords, toCoords);
        infoDiv.innerHTML = `<div style="color:blue">Đã tìm thấy tuyến đường. Xem thông tin ước tính phía trên.</div>`;

      } catch (e) {
        alert(e.message || 'Lỗi khi geocode hoặc tìm tuyến'); 
        infoDiv.innerHTML = `<div style="color:var(--danger-color);">Lỗi: ${e.message || 'Không tìm thấy địa điểm hoặc tuyến đường.'}</div>`;
        requestBtn.disabled = true;
      } finally {
        estimateBtn.disabled = false;
      }
    });

    // Button: Request (push ride into /rides)
    requestBtn.addEventListener('click', async () => {
      if (!lastRouteSummary) return alert('Chưa có tuyến');
      if (currentRideId) return alert("Bạn đang có cuốc xe đang hoạt động!");

      const from = document.getElementById('from').value.trim();
      const to = document.getElementById('to').value.trim();
      const vehicle = document.getElementById('vehicle').value;
      const km = lastRouteSummary.distance / 1000;
      const mins = Math.round(lastRouteSummary.duration / 60);

      // calculate fare
      let fare = 0;
      if (vehicle === 'bike') fare = Math.max(Math.round(km * PRICE.bikePerKm), PRICE.bikeMin);
      else fare = Math.max(Math.round(km * PRICE.carPerKm), PRICE.carMin);

      const waypointFrom = routingControl.getWaypoints()[0].latLng;
      const waypointTo = routingControl.getWaypoints()[1].latLng;

      // create ride object
      const ride = {
        createdAt: Date.now(),
        status: 'finding',
        fromText: from,
        toText: to,
        from: { lat: waypointFrom.lat, lng: waypointFrom.lng }, 
        to: { lat: waypointTo.lat, lng: waypointTo.lng },
        distance_m: lastRouteSummary.distance,
        duration_s: lastRouteSummary.duration,
        distance_km: km,
        duration_min: mins,
        fare: fare,
        vehicle: vehicle
      };

      try {
        const ridesRef = ref(db, 'rides');
        requestBtn.disabled = true;
        const newRef = await push(ridesRef, ride);
        
        infoDiv.innerHTML = `<div style="color:blue">Đã gọi xe. ID: ${newRef.key}. Đang tìm tài xế...</div>`;
        
        // Ẩn khu vực nhập liệu và hiển thị Overlay trạng thái
        setInputControlsActive(false); 
        
        listenToRide(newRef.key);

      } catch (e) {
        alert('Lỗi gửi yêu cầu: ' + (e.message || e));
        requestBtn.disabled = false;
      }
    });

    // Gọi hàm định vị khi trang được tải
    getCurrentLocationAndInitMap();

  </script>
</body>
</html>
