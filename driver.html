<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Driver — Nhận cuốc</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="style.css" /> 
</head>
<body>
  <div class="map-page-container">
    <div id="map"></div>
    
    <div id="statusControl" class="overlay-card" style="top: 20px; bottom: auto; padding: 10px 15px;">
        <h2 style="margin:0; padding: 0; font-size: 1.2em; border: none;">Trạng thái tài xế</h2>
        <div id="driverInfo" style="font-weight: bold; margin-bottom: 10px;">Chưa online</div>
        <input id="driverName" placeholder="Tên tài xế (Ví dụ: Tài xế A)"/>
        <div class="row" style="margin-top: 5px;">
            <button id="goOnline" class="btn btn-primary col">Bật Online</button>
            <button id="goOffline" class="btn btn-danger col" style="display:none">Tắt Online</button>
        </div>
    </div>

    <div id="activeRideOverlay" class="overlay-card" style="display:none; transition: all 0.3s ease-in-out;">
        </div>

    <div id="newRidesList" style="position: absolute; top: 20px; right: 15px; z-index: 20; max-height: 50vh; overflow-y: auto;">
        </div>
  </div>


  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getDatabase, ref, set, remove, onChildAdded, onChildChanged,
      onValue, update, push
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // Cấu hình Firebase (Giữ nguyên)
    const firebaseConfig = {
      apiKey: "AIzaSyCUQpfPPlJqLRm9FyryfX2UOa82mUWbJrE",
      authDomain: "robotkitkat6-bee.firebaseapp.com",
      databaseURL: "https://robotkitkat6-bee-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "robotkitkat6-bee",
      storageBucket: "robotkitkat6-bee.firebasestorage.app",
      messagingSenderId: "117130770804",
      appId: "1:117130770804:web:4827cc61a7c9df99549421",
      measurementId: "G-WMKP4GT930"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Map init (Giữ nguyên)
    const map = L.map('map').setView([10.762622, 106.660172], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let driverMarker = L.marker([10.762622, 106.660172], { draggable:true }).addTo(map);
    driverMarker.bindPopup('Bạn (tài xế)').openPopup();

    const DRIVER_ID_KEY = 'driverUniqueId';
    let DRIVER_ID = localStorage.getItem(DRIVER_ID_KEY);
    if (!DRIVER_ID) {
      DRIVER_ID = 'driver_' + Date.now() + '_' + Math.floor(Math.random()*9999);
      localStorage.setItem(DRIVER_ID_KEY, DRIVER_ID);
    }
    
    let lastPos = null;
    let online = false;
    let watchId = null;

    // SỬA: requestsDiv đổi thành newRidesList cho cuốc mới
    const newRidesList = document.getElementById('newRidesList'); 
    const activeRideOverlay = document.getElementById('activeRideOverlay'); 
    const statusControl = document.getElementById('statusControl');

    let shownRides = {}; // rideId -> { el, routeControl, accepted: bool }

    // Constants for localStorage (Giữ nguyên)
    const STORAGE_KEY_STATUS = 'driverOnlineStatus';
    const STORAGE_KEY_NAME = 'driverName';

    // === HÀM LƯU/TẢI TRẠNG THÁI (PERSISTENCE) === (Giữ nguyên)
    function saveDriverState(isOnline, name) {
        localStorage.setItem(STORAGE_KEY_STATUS, isOnline ? 'online' : 'offline');
        localStorage.setItem(STORAGE_KEY_NAME, name);
    }

    function loadDriverState() {
        const savedName = localStorage.getItem(STORAGE_KEY_NAME);
        if (savedName) {
            document.getElementById('driverName').value = savedName;
        }
        const savedStatus = localStorage.getItem(STORAGE_KEY_STATUS);
        if (savedStatus === 'online') {
            document.getElementById('goOnline').click();
        }
    }
    // ===========================================

    // Helpers for DB (Giữ nguyên)
    const driversRef = ref(db, 'drivers');
    const ridesRef = ref(db, 'rides');

    async function setDriverOnline(name, lat, lng) {
      const dRef = ref(db, 'drivers/' + DRIVER_ID);
      await set(dRef, { id: DRIVER_ID, name, lat, lng, online: true, updatedAt: Date.now() });
      document.getElementById('driverInfo').innerText = 'Online như: ' + name;
      // Ẩn control/hiển thị map
      statusControl.style.top = '20px';
      statusControl.style.left = 'auto';
      statusControl.style.right = '15px';
      statusControl.style.width = '200px'; 
    }
    async function setDriverOffline() {
      const dRef = ref(db, 'drivers/' + DRIVER_ID);
      await remove(dRef).catch(()=>{});
      document.getElementById('driverInfo').innerText = 'Bạn đã offline';
      // Hiển thị control to hơn
      statusControl.style.top = '20px';
      statusControl.style.left = '15px';
      statusControl.style.right = '15px';
      statusControl.style.width = 'auto';
    }
    //... (Giữ nguyên updateDriverLocation, startWatch, stopWatch) ...
    async function updateDriverLocation(lat, lng) {
        lastPos = { lat, lng };
        driverMarker.setLatLng([lat,lng]);
        map.panTo([lat,lng]);
        const dRef = ref(db, 'drivers/' + DRIVER_ID);
        await update(dRef, { lat, lng, updatedAt: Date.now() }).catch(()=>{});
        
        // CẬP NHẬT VỊ TRÍ TÀI XẾ CHO CUỐC XE ĐANG CHẠY
        Object.keys(shownRides).forEach(rideId => {
            const s = shownRides[rideId];
            if (s.accepted) { // Chỉ cập nhật cho cuốc đã nhận
                const rideRef = ref(db, 'rides/' + rideId);
                update(rideRef, {
                    driverLat: lat,
                    driverLng: lng
                });
                if (s.routeControl) {
                    const waypoints = s.routeControl.getWaypoints();
                    if (waypoints.length > 0) {
                        waypoints[0].latLng = L.latLng(lat, lng);
                        s.routeControl.setWaypoints(waypoints);
                    }
                }
            }
        });
    }

    function startWatch() {
      if (!navigator.geolocation) { alert('Trình duyệt không hỗ trợ định vị'); return; }
      navigator.geolocation.getCurrentPosition(async (p) => {
        await updateDriverLocation(p.coords.latitude, p.coords.longitude);
      }, ()=>{}, { enableHighAccuracy:true });
      
      watchId = navigator.geolocation.watchPosition(async (p) => {
        await updateDriverLocation(p.coords.latitude, p.coords.longitude);
      }, (err)=>console.warn(err), { enableHighAccuracy:true, maximumAge:2000, timeout:10000 });
    }
    function stopWatch() { if (watchId) navigator.geolocation.clearWatch(watchId); watchId = null; }

    // FETCH RIDES (Giữ nguyên logic lắng nghe)
    onChildAdded(ridesRef, (snap) => {
      const ride = snap.val(); const rideId = snap.key;
      if (!online || !ride) return;
      if (!lastPos) return; 
      checkAndShowRide(rideId, ride);
    });

    onChildChanged(ridesRef, (snap) => {
      const ride = snap.val(); const rideId = snap.key;
      if (!online || !ride) return;
      
      if (ride.status !== 'finding' && ride.driverId !== DRIVER_ID) {
        removeRideFromUI(rideId);
        return;
      }
      if (lastPos) checkAndShowRide(rideId, ride);
    });

    function checkAndShowRide(rideId, rideObj) {
        if (!rideObj.from) return;
        const driverPt = turf.point([lastPos.lng, lastPos.lat]);
        const pickupPt = turf.point([rideObj.from.lng, rideObj.from.lat]);
        const d = turf.distance(driverPt, pickupPt, { units: 'kilometers' });
        
        const isFindingAndNear = (rideObj.status === 'finding' && d <= 3);
        const isAcceptedByMe = (rideObj.driverId === DRIVER_ID && (rideObj.status === 'accepted' || rideObj.status === 'onTrip'));
        
        if (isFindingAndNear) {
            // Cuốc mới đến, hiển thị ở newRidesList
            if (!shownRides[rideId]) {
                createRideUI(rideId, rideObj, d);
            }
            updateRideUI(rideId, rideObj, d);
        } else if (isAcceptedByMe) {
            // Cuốc đã nhận, hiển thị ở activeRideOverlay và ẩn khỏi newRidesList
            if (!shownRides[rideId]) {
                createRideUI(rideId, rideObj, d, true); // Tạo UI ngay trong overlay
            }
            updateRideUI(rideId, rideObj, d);
            // Ẩn các cuốc mới khác nếu có cuốc đang chạy
            newRidesList.style.display = 'none';
        } else {
            removeRideFromUI(rideId);
        }
    }

    // SỬA: Tách logic tạo UI cho cuốc mới và cuốc đang chạy
    function createRideUI(rideId, rideObj, distKm, isActive = false) {
      const el = document.createElement('div');
      el.className = isActive ? 'active-request' : 'request';
      el.id = 'ride_' + rideId;
      
      el.dataset.fromLat = rideObj.from.lat; 
      el.dataset.fromLng = rideObj.from.lng;
      el.dataset.toLat = rideObj.to.lat;
      el.dataset.toLng = rideObj.to.lng;

      const pickup = `${rideObj.fromText || '—'}`;
      const dest = `${rideObj.toText || '—'}`;
      el.innerHTML = `
        <h3 style="margin-top: 0; font-size: 1.1em; color: var(--primary-color);">Cuốc xe #${rideId.slice(-4)}</h3>
        <div class="distance-info" style="font-weight: bold;">Cách bạn: ${distKm.toFixed(2)} km</div>
        <div style="margin: 5px 0;">Đón: ${pickup}</div>
        <div style="margin: 5px 0;">Đến: ${dest}</div>
        <div style="margin: 5px 0;">Giá: <b>${rideObj.fare ? rideObj.fare.toLocaleString() + ' đ' : '—'}</b> (${rideObj.vehicle === 'bike' ? 'Xe máy' : 'Ô tô'})</div>
        <div class="row request-actions" style="margin-top: 10px;"></div>
      `;
      
      if (isActive) {
          activeRideOverlay.innerHTML = '';
          activeRideOverlay.appendChild(el);
          activeRideOverlay.style.display = 'block';
      } else {
          newRidesList.prepend(el);
          newRidesList.style.display = 'block';
      }
      shownRides[rideId] = { el, routeControl: null, accepted:isActive, currentStatus: rideObj.status };
    }

    function removeRideFromUI(rideId) {
      const s = shownRides[rideId];
      if (!s) return;
      if (s.routeControl) { try { map.removeControl(s.routeControl); } catch(e){} }
      if (s.el) s.el.remove();
      delete shownRides[rideId];
      
      // Ẩn Overlay nếu không còn cuốc nào
      if (activeRideOverlay.children.length === 0) {
          activeRideOverlay.style.display = 'none';
          newRidesList.style.display = 'block'; // Hiện lại danh sách cuốc mới nếu có
      }
    }

    // HÀM CẬP NHẬT GIAO DIỆN VÀ NÚT BẤM (ĐÃ SỬA LỖI THIẾU NÚT NHẬN CUỐC)
    function updateRideUI(rideId, rideObj, distKm) {
        const s = shownRides[rideId];
        if (!s) return; 

        const distEl = s.el.querySelector('.distance-info');
        if (distEl) distEl.innerHTML = `Cách bạn: ${distKm.toFixed(2)} km`;
        
        const actionsDiv = s.el.querySelector('.request-actions');
        
        // --- LOGIC HIỂN THỊ NÚT CHO CUỐC ĐANG TÌM KIẾM (finding) ---
        if (rideObj.status === 'finding' && !s.accepted) {
            // Đảm bảo nó hiển thị trong newRidesList (nếu có)
            if (s.el.parentElement.id !== 'newRidesList') {
                removeRideFromUI(rideId);
                createRideUI(rideId, rideObj, distKm, false);
                return;
            }

            actionsDiv.innerHTML = '';
            const acceptBtn = document.createElement('button');
            acceptBtn.className = 'btn btn-accept col'; 
            acceptBtn.innerText = 'NHẬN CUỐC';
            acceptBtn.onclick = () => acceptRide(rideId, rideObj, s.el);
            actionsDiv.appendChild(acceptBtn);
            
            if (s.routeControl) { map.removeControl(s.routeControl); s.routeControl = null; }
            return;
        } 
        
        // --- LOGIC HIỂN THỊ NÚT CHO CUỐC ĐÃ NHẬN (accepted/onTrip) ---
        if (rideObj.driverId === DRIVER_ID && (rideObj.status === 'accepted' || rideObj.status === 'onTrip')) {
            // Đảm bảo nó được chuyển sang activeRideOverlay
            if (s.el.parentElement.id !== 'activeRideOverlay') {
                 s.el.remove();
                 createRideUI(rideId, rideObj, distKm, true);
                 const newS = shownRides[rideId]; // Lấy lại object mới
                 newS.currentStatus = ''; // Buộc cập nhật
                 updateRideUI(rideId, rideObj, distKm);
                 return;
            }
            
            if (s.currentStatus === rideObj.status && s.accepted) return; 

            s.accepted = true;
            s.currentStatus = rideObj.status;
            actionsDiv.innerHTML = '';
            
            const fromLat = parseFloat(s.el.dataset.fromLat);
            const fromLng = parseFloat(s.el.dataset.fromLng);
            const toLat = parseFloat(s.el.dataset.toLat);
            const toLng = parseFloat(s.el.dataset.toLng);
            const pickup = [fromLat, fromLng];
            const dest = [toLat, toLng];

            // 1. Nút thông báo trạng thái
            const statusText = rideObj.status === 'accepted' ? 'Đang chạy đến đón khách' : 'ĐANG TRÊN ĐƯỜNG';
            s.el.querySelector('h3').innerHTML = `<span style="color:var(--success-color);">${statusText}</span>`;
            
            // 2. Nút hành động chính
            let actionBtn;
            if (rideObj.status === 'accepted') {
                actionBtn = document.createElement('button');
                actionBtn.className = 'btn btn-primary col';
                actionBtn.innerText = 'ĐÃ ĐÓN KHÁCH (Start Trip)';
                actionBtn.onclick = () => startTrip(rideId, s.el);
            } else if (rideObj.status === 'onTrip') {
                actionBtn = document.createElement('button');
                actionBtn.className = 'btn btn-complete col';
                actionBtn.innerText = 'HOÀN THÀNH CUỐC';
                actionBtn.onclick = () => completeRide(rideId, s.el);
            }

            // 3. Nút Hủy cuốc
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'btn btn-danger col';
            cancelBtn.innerText = 'HỦY CUỐC';
            cancelBtn.onclick = () => cancelRide(rideId, s.el);
            
            actionsDiv.appendChild(actionBtn);
            actionsDiv.appendChild(cancelBtn);
            
            // Vẽ/Cập nhật Route
            if (s.routeControl) { map.removeControl(s.routeControl); s.routeControl = null; }

            let waypoints;
            if (rideObj.status === 'accepted') {
                waypoints = [ L.latLng(lastPos.lat, lastPos.lng), L.latLng(pickup[0], pickup[1]), L.latLng(dest[0], dest[1]) ]; 
            } else if (rideObj.status === 'onTrip') {
                waypoints = [ L.latLng(lastPos.lat, lastPos.lng), L.latLng(dest[0], dest[1]) ]; 
            }

            s.routeControl = L.Routing.control({
                waypoints,
                router: L.Routing.osrmv1({serviceUrl: 'https://router.project-osrm.org/route/v1'}),
                fitSelectedRoutes: true,
                addWaypoints: false,
                showAlternatives: false,
                lineOptions: { styles: [{ color: '#007bff', weight: 6, opacity: 0.7 }] } 
            }).addTo(map);

             // Tùy chỉnh map view để hiển thị toàn bộ route (nếu có)
             if (s.routeControl && s.routeControl.getPlan() && s.routeControl.getPlan().setWaypoints) {
                s.routeControl.route(); // Yêu cầu vẽ lại route
             }
        }
    }
    // ... (Giữ nguyên các hàm startTrip, cancelRide, acceptRide, completeRide) ...
    async function startTrip(rideId, el) {
        if (!confirm("Xác nhận bạn đã đón khách và bắt đầu hành trình đến điểm đến?")) return;
        try {
            const rideRef = ref(db, 'rides/' + rideId);
            await update(rideRef, {
                status: 'onTrip', 
                startedTripAt: Date.now()
            });
        } catch (e) { alert('Lỗi khi bắt đầu hành trình: ' + (e.message || e)); }
    }
    async function cancelRide(rideId, el) {
        if (!confirm("Bạn chắc chắn muốn hủy cuốc xe này? Việc hủy sẽ thông báo cho khách và xóa cuốc xe.")) return;
        try {
            const rideRef = ref(db, 'rides/' + rideId);
            await remove(rideRef); 
            alert('Đã hủy cuốc xe: ' + rideId);
            removeRideFromUI(rideId);
        } catch (e) { alert('Lỗi hủy chuyến: ' + (e.message || e)); }
    }
    async function acceptRide(rideId, rideObj, el) {
      const rideRef = ref(db, 'rides/' + rideId);
      onValue(rideRef, async (snap) => {
        const current = snap.val();
        if (!current) { alert('Cuốc đã bị hủy'); removeRideFromUI(rideId); return; }
        if (current.status && current.status !== 'finding') { alert('Cuốc đã được nhận bởi người khác'); removeRideFromUI(rideId); return; }

        const driverName = document.getElementById('driverName').value || ('Tài xế_' + DRIVER_ID.slice(-4));
        await update(rideRef, {
          status: 'accepted',
          driverId: DRIVER_ID,
          driverName,
          driverLat: lastPos.lat,
          driverLng: lastPos.lng,
          acceptedAt: Date.now()
        });
      }, { onlyOnce: true });
    }
    async function completeRide(rideId, el) {
      if (!confirm("Xác nhận đã hoàn thành cuốc xe?")) return;
      const rideRef = ref(db, 'rides/' + rideId);
      onValue(rideRef, async (snap) => {
        const current = snap.val();
        if (!current) { alert('Cuốc không tồn tại'); removeRideFromUI(rideId); return; }
        const historyRef = ref(db, 'history');
        const entry = {
          ...current,
          completedAt: Date.now(),
          completedBy: DRIVER_ID
        };
        await push(historyRef, entry);
        await remove(rideRef).catch(()=>{});
        alert('Đã hoàn thành cuốc: ' + rideId);
        removeRideFromUI(rideId);
      }, { onlyOnce: true });
    }
    
    // --- BUTTON HANDLERS ---
    document.getElementById('goOnline').addEventListener('click', async () => {
      const name = document.getElementById('driverName').value || ('Tài xế_' + DRIVER_ID.slice(-4));
      online = true;
      document.getElementById('goOnline').style.display = 'none';
      document.getElementById('goOffline').style.display = 'inline-block';
      document.getElementById('driverInfo').innerText = 'Kết nối...';
      startWatch();
      
      saveDriverState(true, name);

      setTimeout(async () => {
        if (!lastPos) {
          alert('Không lấy được vị trí — kiểm tra quyền truy cập vị trí');
          document.getElementById('goOnline').style.display = 'inline-block';
          document.getElementById('goOffline').style.display = 'none';
          document.getElementById('driverInfo').innerText = 'Lỗi kết nối vị trí';
          online = false;
          saveDriverState(false, name);
          return;
        }
        await setDriverOnline(name, lastPos.lat, lastPos.lng);
      }, 900);
    });

    document.getElementById('goOffline').addEventListener('click', async () => {
      online = false;
      document.getElementById('goOnline').style.display = 'inline-block';
      document.getElementById('goOffline').style.display = 'none';
      stopWatch();
      await setDriverOffline();
      newRidesList.innerHTML = '';
      activeRideOverlay.style.display = 'none';
      shownRides = {};
      saveDriverState(false, document.getElementById('driverName').value);
    });

    window.addEventListener('beforeunload', async () => {
      if (online) { 
        await setDriverOffline(); 
      }
    });

    loadDriverState(); 
  </script>
</body>
</html>
