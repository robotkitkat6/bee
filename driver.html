<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Driver — Nhận cuốc</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="style.css" /> </head>
<body>
  <h2>Driver — Bật Online</h2>
  <input id="driverName" placeholder="Tên tài xế (ví dụ: Tài xế A)"/>
  <div style="display:flex;gap:8px;">
    <button id="goOnline" class="btn btn-primary col">Bật Online</button>
    <button id="goOffline" class="btn btn-secondary col" style="display:none">Tắt Online</button>
  </div>

  <div id="driverInfo">Chưa online</div>

  <h3>Cuốc gần bạn (≤ 3 km)</h3>
  <div id="requests"></div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getDatabase, ref, set, remove, onChildAdded, onChildChanged,
      onValue, update, push
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // Cấu hình Firebase (Đã đồng bộ)
    const firebaseConfig = {
      apiKey: "AIzaSyCUQpfPPlJqLRm9FyryfX2UOa82mUWbJrE",
      authDomain: "robotkitkat6-bee.firebaseapp.com",
      databaseURL: "https://robotkitkat6-bee-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "robotkitkat6-bee",
      storageBucket: "robotkitkat6-bee.firebasestorage.app",
      messagingSenderId: "117130770804",
      appId: "1:117130770804:web:4827cc61a7c9df99549421",
      measurementId: "G-WMKP4GT930"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Map init
    const map = L.map('map').setView([10.762622, 106.660172], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let driverMarker = L.marker([10.762622, 106.660172], { draggable:true }).addTo(map);
    driverMarker.bindPopup('Bạn (tài xế)').openPopup();

    // Sử dụng ID duy nhất cho tài xế và lưu vào localStorage để duy trì
    const DRIVER_ID_KEY = 'driverUniqueId';
    let DRIVER_ID = localStorage.getItem(DRIVER_ID_KEY);
    if (!DRIVER_ID) {
      DRIVER_ID = 'driver_' + Date.now() + '_' + Math.floor(Math.random()*9999);
      localStorage.setItem(DRIVER_ID_KEY, DRIVER_ID);
    }
    
    let lastPos = null;
    let online = false;
    let watchId = null;
    const requestsDiv = document.getElementById('requests');
    let shownRides = {}; // rideId -> { el, routeControl, accepted: bool }

    // Constants for localStorage
    const STORAGE_KEY_STATUS = 'driverOnlineStatus';
    const STORAGE_KEY_NAME = 'driverName';

    // === HÀM LƯU/TẢI TRẠNG THÁI (PERSISTENCE) ===
    function saveDriverState(isOnline, name) {
        localStorage.setItem(STORAGE_KEY_STATUS, isOnline ? 'online' : 'offline');
        localStorage.setItem(STORAGE_KEY_NAME, name);
    }

    function loadDriverState() {
        const savedName = localStorage.getItem(STORAGE_KEY_NAME);
        if (savedName) {
            document.getElementById('driverName').value = savedName;
        }
        const savedStatus = localStorage.getItem(STORAGE_KEY_STATUS);
        if (savedStatus === 'online') {
            document.getElementById('goOnline').click(); // Tự động bật online
        }
    }
    // ===========================================

    // Helpers for DB
    const driversRef = ref(db, 'drivers');
    const ridesRef = ref(db, 'rides');

    async function setDriverOnline(name, lat, lng) {
      const dRef = ref(db, 'drivers/' + DRIVER_ID);
      await set(dRef, { id: DRIVER_ID, name, lat, lng, online: true, updatedAt: Date.now() });
      document.getElementById('driverInfo').innerText = 'Online như: ' + name;
    }
    async function setDriverOffline() {
      const dRef = ref(db, 'drivers/' + DRIVER_ID);
      await remove(dRef).catch(()=>{});
      document.getElementById('driverInfo').innerText = 'Bạn đã offline';
    }
    async function updateDriverLocation(lat, lng) {
      lastPos = { lat, lng };
      driverMarker.setLatLng([lat,lng]);
      map.panTo([lat,lng]);
      const dRef = ref(db, 'drivers/' + DRIVER_ID);
      await update(dRef, { lat, lng, updatedAt: Date.now() }).catch(()=>{});
      
      // CẬP NHẬT VỊ TRÍ TÀI XẾ CHO CUỐC XE ĐANG CHẠY
      Object.keys(shownRides).forEach(rideId => {
          const s = shownRides[rideId];
          if (s.accepted) { // Chỉ cập nhật cho cuốc đã nhận
              const rideRef = ref(db, 'rides/' + rideId);
              update(rideRef, {
                  driverLat: lat,
                  driverLng: lng
              });
              // Cập nhật vị trí bắt đầu của tuyến đường
              if (s.routeControl) {
                  const waypoints = s.routeControl.getWaypoints();
                  // Vị trí tài xế luôn là điểm đầu tiên
                  if (waypoints.length > 0) {
                    waypoints[0].latLng = L.latLng(lat, lng);
                    s.routeControl.setWaypoints(waypoints);
                  }
              }
          }
      });
    }

    // Geolocation (Giữ nguyên logic sửa lỗi trùng lặp trước)
    function startWatch() {
      if (!navigator.geolocation) { alert('Trình duyệt không hỗ trợ định vị'); return; }
      navigator.geolocation.getCurrentPosition(async (p) => {
        await updateDriverLocation(p.coords.latitude, p.coords.longitude);
      }, ()=>{}, { enableHighAccuracy:true });
      
      watchId = navigator.geolocation.watchPosition(async (p) => {
        await updateDriverLocation(p.coords.latitude, p.coords.longitude);
      }, (err)=>console.warn(err), { enableHighAccuracy:true, maximumAge:2000, timeout:10000 });
    }
    function stopWatch() { if (watchId) navigator.geolocation.clearWatch(watchId); watchId = null; }

    // FETCH RIDES: Lắng nghe thêm/thay đổi cuốc xe
    onChildAdded(ridesRef, (snap) => {
      const ride = snap.val(); const rideId = snap.key;
      if (!online || !ride) return; // Chỉ xử lý khi tài xế online
      if (!lastPos) return; 
      checkAndShowRide(rideId, ride);
    });

    onChildChanged(ridesRef, (snap) => {
      const ride = snap.val(); const rideId = snap.key;
      if (!online || !ride) return; // Chỉ xử lý khi tài xế online
      
      // Nếu cuốc xe không còn 'finding' và không phải cuốc của mình, loại bỏ khỏi UI
      if (ride.status !== 'finding' && ride.driverId !== DRIVER_ID) {
        removeRideFromUI(rideId);
        return;
      }
      if (lastPos) checkAndShowRide(rideId, ride);
    });

    function checkAndShowRide(rideId, rideObj) {
      if (!rideObj.from) return;
      const driverPt = turf.point([lastPos.lng, lastPos.lat]);
      const pickupPt = turf.point([rideObj.from.lng, rideObj.from.lat]);
      const d = turf.distance(driverPt, pickupPt, { units: 'kilometers' });
      
      const isFindingAndNear = (rideObj.status === 'finding' && d <= 3);
      const isAcceptedByMe = (rideObj.driverId === DRIVER_ID && (rideObj.status === 'accepted' || rideObj.status === 'onTrip'));
      
      if (isFindingAndNear || isAcceptedByMe) {
        if (!shownRides[rideId]) {
          createRideUI(rideId, rideObj, d);
        }
        updateRideUI(rideId, rideObj, d);
      } else {
        removeRideFromUI(rideId);
      }
    }

    function createRideUI(rideId, rideObj, distKm) {
      const el = document.createElement('div');
      el.className = 'request';
      el.id = 'ride_' + rideId;
      
      // LƯU TỌA ĐỘ VÀO DATASET
      el.dataset.fromLat = rideObj.from.lat; 
      el.dataset.fromLng = rideObj.from.lng;
      el.dataset.toLat = rideObj.to.lat;
      el.dataset.toLng = rideObj.to.lng;

      const pickup = `${rideObj.fromText || '—'}`;
      const dest = `${rideObj.toText || '—'}`;
      el.innerHTML = `
        <div><b>ID:</b> ${rideId}</div>
        <div><b>Loại:</b> ${rideObj.vehicle === 'bike' ? 'Xe máy' : 'Ô tô'}</div>
        <div class="distance-info"><b>Cách bạn:</b> ${distKm.toFixed(2)} km</div>
        <div><b>Điểm đón:</b> ${pickup}</div>
        <div><b>Điểm đến:</b> ${dest}</div>
        <div><b>Giá ước tính:</b> ${rideObj.fare ? rideObj.fare.toLocaleString() + ' đ' : '—'}</div>
        <div class="row request-actions"></div>
      `;
      
      requestsDiv.prepend(el);
      shownRides[rideId] = { el, routeControl: null, accepted:false, currentStatus: rideObj.status };
    }

    function removeRideFromUI(rideId) {
      const s = shownRides[rideId];
      if (!s) return;
      if (s.routeControl) { try { map.removeControl(s.routeControl); } catch(e){} }
      if (s.el) s.el.remove();
      delete shownRides[rideId];
    }

    // HÀM CẬP NHẬT GIAO DIỆN VÀ NÚT BẤM (ĐÃ SỬA LỖI THIẾU NÚT NHẬN CUỐC)
    function updateRideUI(rideId, rideObj, distKm) {
        const s = shownRides[rideId];
        if (!s) return; 

        // Cập nhật khoảng cách
        const distEl = s.el.querySelector('.distance-info');
        if (distEl) distEl.innerHTML = `<b>Cách bạn:</b> ${distKm.toFixed(2)} km`;
        
        const actionsDiv = s.el.querySelector('.request-actions');
        
        // --- LOGIC HIỂN THỊ NÚT CHO CUỐC ĐANG TÌM KIẾM (finding) ---
        if (rideObj.status === 'finding') {
            s.accepted = false; 
            actionsDiv.innerHTML = ''; // Xóa nút cũ

            const acceptBtn = document.createElement('button');
            acceptBtn.className = 'btn btn-accept'; 
            acceptBtn.innerText = 'Nhận cuốc';
            acceptBtn.style.flex = 1;
            acceptBtn.onclick = () => acceptRide(rideId, rideObj, s.el);

            actionsDiv.appendChild(acceptBtn);
            
            // Xóa tuyến đường nếu đang hiển thị
            if (s.routeControl) { map.removeControl(s.routeControl); s.routeControl = null; }
            return;
        } 
        
        // --- LOGIC HIỂN THỊ NÚT CHO CUỐC ĐÃ NHẬN (accepted/onTrip) ---
        if (rideObj.driverId === DRIVER_ID && (rideObj.status === 'accepted' || rideObj.status === 'onTrip')) {
            // Chỉ re-render khi trạng thái thay đổi hoặc lần đầu tiên được chấp nhận
            if (s.currentStatus === rideObj.status && s.accepted) return; 

            s.accepted = true;
            s.currentStatus = rideObj.status;
            actionsDiv.innerHTML = ''; // Xóa nút cũ
            
            const fromLat = parseFloat(s.el.dataset.fromLat);
            const fromLng = parseFloat(s.el.dataset.fromLng);
            const toLat = parseFloat(s.el.dataset.toLat);
            const toLng = parseFloat(s.el.dataset.toLng);
            const pickup = [fromLat, fromLng];
            const dest = [toLat, toLng];

            // 1. Nút thông báo trạng thái
            const statusBtn = document.createElement('button');
            statusBtn.innerText = rideObj.status === 'accepted' ? 'Đang chạy đến điểm đón' : 'Đang trên đường (On Trip)';
            statusBtn.disabled = true;
            statusBtn.className = 'btn btn-disabled';
            statusBtn.style.flex = 1;
            
            // 2. Nút hành động chính
            let actionBtn;
            if (rideObj.status === 'accepted') {
                actionBtn = document.createElement('button');
                actionBtn.className = 'btn btn-primary';
                actionBtn.innerText = 'Đã đón khách (Start Trip)';
                actionBtn.onclick = () => startTrip(rideId, s.el);
            } else if (rideObj.status === 'onTrip') {
                actionBtn = document.createElement('button');
                actionBtn.className = 'btn btn-complete';
                actionBtn.innerText = 'Hoàn thành cuốc';
                actionBtn.onclick = () => completeRide(rideId, s.el);
            }

            // 3. Nút Hủy cuốc
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'btn btn-danger';
            cancelBtn.innerText = 'Hủy cuốc';
            cancelBtn.style.flex = 1;
            cancelBtn.onclick = () => cancelRide(rideId, s.el);
            
            // Thêm các nút vào hàng mới
            actionsDiv.appendChild(statusBtn);
            if (actionBtn) actionsDiv.appendChild(actionBtn);
            actionsDiv.appendChild(cancelBtn);
            
            // Vẽ/Cập nhật Route
            if (s.routeControl) { map.removeControl(s.routeControl); s.routeControl = null; } // Xóa tuyến đường cũ

            let waypoints;
            if (rideObj.status === 'accepted') {
                // Tuyến đường: Driver -> Pickup -> Destination
                waypoints = [ L.latLng(lastPos.lat, lastPos.lng), L.latLng(pickup[0], pickup[1]), L.latLng(dest[0], dest[1]) ]; 
            } else if (rideObj.status === 'onTrip') {
                // Tuyến đường: Pickup -> Destination (Vì tài xế đang ở điểm đón)
                waypoints = [ L.latLng(pickup[0], pickup[1]), L.latLng(dest[0], dest[1]) ]; 
            }

            s.routeControl = L.Routing.control({
                waypoints,
                router: L.Routing.osrmv1({serviceUrl: 'https://router.project-osrm.org/route/v1'}),
                fitSelectedRoutes: true,
                addWaypoints: false,
                showAlternatives: false
            }).addTo(map);
        }
    }
    // -------------------------------------------------------------

    // --- HÀM BẮT ĐẦU HÀNH TRÌNH (START TRIP) ---
    async function startTrip(rideId, el) {
        if (!confirm("Xác nhận bạn đã đón khách và bắt đầu hành trình đến điểm đến?")) return;

        try {
            const rideRef = ref(db, 'rides/' + rideId);
            await update(rideRef, {
                status: 'onTrip', 
                startedTripAt: Date.now()
            });
            // onChildChanged sẽ tự động gọi updateRideUI để cập nhật giao diện
        } catch (e) {
            alert('Lỗi khi bắt đầu hành trình: ' + (e.message || e));
        }
    }
    // ---------------------------------------------------


    // --- HÀM HỦY CUỐC (DRIVER) ---
    async function cancelRide(rideId, el) {
        if (!confirm("Bạn chắc chắn muốn hủy cuốc xe này? Việc hủy sẽ thông báo cho khách và xóa cuốc xe.")) return;

        try {
            const rideRef = ref(db, 'rides/' + rideId);
            await remove(rideRef); 

            alert('Đã hủy cuốc xe: ' + rideId);
            removeRideFromUI(rideId);
        } catch (e) {
            alert('Lỗi hủy chuyến: ' + (e.message || e));
        }
    }
    // -----------------------------------


    // Accept ride
    async function acceptRide(rideId, rideObj, el) {
      const rideRef = ref(db, 'rides/' + rideId);
      onValue(rideRef, async (snap) => {
        const current = snap.val();
        if (!current) { alert('Cuốc đã bị hủy'); removeRideFromUI(rideId); return; }
        if (current.status && current.status !== 'finding') { alert('Cuốc đã được nhận bởi người khác'); removeRideFromUI(rideId); return; }

        const driverName = document.getElementById('driverName').value || ('Tài xế_' + DRIVER_ID.slice(-4));
        await update(rideRef, {
          status: 'accepted',
          driverId: DRIVER_ID,
          driverName,
          driverLat: lastPos.lat,
          driverLng: lastPos.lng,
          acceptedAt: Date.now()
        });
        // Sau khi update, onChildChanged sẽ tự động gọi updateRideUI để vẽ lại các nút
      }, { onlyOnce: true });
    }

    // Complete ride: push to /history then remove ride
    async function completeRide(rideId, el) {
      if (!confirm("Xác nhận đã hoàn thành cuốc xe?")) return;

      const rideRef = ref(db, 'rides/' + rideId);
      onValue(rideRef, async (snap) => {
        const current = snap.val();
        if (!current) { alert('Cuốc không tồn tại'); removeRideFromUI(rideId); return; }

        const historyRef = ref(db, 'history');
        const entry = {
          ...current,
          completedAt: Date.now(),
          completedBy: DRIVER_ID
        };
        await push(historyRef, entry);
        await remove(rideRef).catch(()=>{});
        alert('Đã hoàn thành cuốc: ' + rideId);
        removeRideFromUI(rideId);
      }, { onlyOnce: true });
    }
    
    // --- BUTTON HANDLERS (ĐÃ THÊM LOGIC LƯU TRẠNG THÁI) ---
    document.getElementById('goOnline').addEventListener('click', async () => {
      const name = document.getElementById('driverName').value || ('Tài xế_' + DRIVER_ID.slice(-4));
      online = true;
      document.getElementById('goOnline').style.display = 'none';
      document.getElementById('goOffline').style.display = 'inline-block';
      document.getElementById('driverInfo').innerText = 'Kết nối...';
      startWatch();
      
      saveDriverState(true, name); // LƯU TRẠNG THÁI ONLINE

      setTimeout(async () => {
        if (!lastPos) {
          alert('Không lấy được vị trí — kiểm tra quyền truy cập vị trí');
          document.getElementById('goOnline').style.display = 'inline-block';
          document.getElementById('goOffline').style.display = 'none';
          document.getElementById('driverInfo').innerText = 'Lỗi kết nối vị trí';
          online = false;
          saveDriverState(false, name); // LƯU TRẠNG THÁI OFFLINE NẾU LỖI
          return;
        }
        await setDriverOnline(name, lastPos.lat, lastPos.lng);
        document.getElementById('driverInfo').innerText = 'Online như: ' + name;
      }, 900);
    });

    document.getElementById('goOffline').addEventListener('click', async () => {
      online = false;
      document.getElementById('goOnline').style.display = 'inline-block';
      document.getElementById('goOffline').style.display = 'none';
      stopWatch();
      await setDriverOffline();
      requestsDiv.innerHTML = '';
      shownRides = {};

      saveDriverState(false, document.getElementById('driverName').value); // LƯU TRẠNG THÁI OFFLINE
    });

    // on unload, set offline (dù có persistence nhưng vẫn cần)
    window.addEventListener('beforeunload', async () => {
      if (online) { 
        await setDriverOffline(); 
        // Không gọi saveDriverState(false) ở đây để giữ lại trạng thái 'online' trong localStorage
        // cho lần tải lại trang tiếp theo.
      }
    });

    // Tự động tải trạng thái khi trang được load
    loadDriverState(); 
  </script>
</body>
</html>
