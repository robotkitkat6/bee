<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Driver ‚Äî Nh·∫≠n cu·ªëc</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="style.css" /> 
</head>
<body>
  <div class="map-page-container">
    <div id="map"></div>
    
    <div id="topStatus">
        Ch∆∞a Online
    </div>
    
    <div id="newRequestCard">
        </div>

    <div id="mainControlOverlay" class="default-view">
        
        <div style="text-align: center; margin-bottom: 10px;">
            <div id="overlayTitle" style="font-weight: bold; color: var(--primary-color);">B·∫£ng ƒêi·ªÅu Khi·ªÉn</div>
        </div>

        <div id="offlineOnlineControls">
            <h2>Thi·∫øt l·∫≠p T√†i x·∫ø</h2>
            <div id="driverNameInput">
                <label>T√™n & Bi·ªÉn s·ªë xe</label>
                <input id="driverName" placeholder="V√≠ d·ª•: Nam H·∫£i - 29L1-33254"/>
            </div>
            <div class="row">
                <button id="goOnline" class="btn btn-success col">B·∫¨T ONLINE</button>
                <button id="goOffline" class="btn btn-danger col" style="display:none;">T·∫ÆT ONLINE</button>
            </div>
        </div>

        <div id="activeRideContent" style="display:none; margin-top: 15px;">
            <h2 id="rideStatusTitle">Cu·ªëc xe ƒëang ch·ªù ƒë√≥n</h2>
            <div id="rideDetails">
                </div>
            <div id="activeRideActions" class="row">
                </div>
            <div class="row">
                 <button id="cancelActiveRideBtn" class="btn btn-danger col">H·ª¶Y CU·ªêC</button>
            </div>
        </div>
    </div>
  </div>


  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getDatabase, ref, set, remove, onChildAdded, onChildChanged, onChildRemoved,
      onValue, update, push
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // C·∫•u h√¨nh Firebase (Gi·ªØ nguy√™n)
    const firebaseConfig = {
      apiKey: "AIzaSyCUQpfPPlJqLRm9FyryfX2UOa82mUWbJrE",
      authDomain: "robotkitkat6-bee.firebaseapp.com",
      databaseURL: "https://robotkitkat6-bee-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "robotkitkat6-bee",
      storageBucket: "robotkitkat6-bee.firebasestorage.app",
      messagingSenderId: "117130770804",
      appId: "1:117130770804:web:4827cc61a7c9df99549421",
      measurementId: "G-WMKP4GT930"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Map init (Gi·ªØ nguy√™n)
    const map = L.map('map').setView([10.762622, 106.660172], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let driverMarker = L.marker([10.762622, 106.660172], { draggable:true }).addTo(map);
    driverMarker.bindPopup('B·∫°n (t√†i x·∫ø)').openPopup();

    const DRIVER_ID_KEY = 'driverUniqueId';
    let DRIVER_ID = localStorage.getItem(DRIVER_ID_KEY);
    if (!DRIVER_ID) {
      DRIVER_ID = 'driver_' + Date.now() + '_' + Math.floor(Math.random()*9999);
      localStorage.setItem(DRIVER_ID_KEY, DRIVER_ID);
    }
    
    let lastPos = null;
    let online = false;
    let watchId = null;

    // Elements
    const topStatus = document.getElementById('topStatus');
    const mainControlOverlay = document.getElementById('mainControlOverlay');
    const offlineOnlineControls = document.getElementById('offlineOnlineControls');
    const activeRideContent = document.getElementById('activeRideContent');
    const newRequestCard = document.getElementById('newRequestCard');
    const goOnlineBtn = document.getElementById('goOnline');
    const goOfflineBtn = document.getElementById('goOffline');
    const driverNameInput = document.getElementById('driverName');

    let shownRides = {}; // Ch·ªâ theo d√µi m·ªôt cu·ªëc xe ƒëang ho·∫°t ƒë·ªông/ƒëang ch·ªù ch·∫•p nh·∫≠n

    const STORAGE_KEY_STATUS = 'driverOnlineStatus';
    const STORAGE_KEY_NAME = 'driverName';
    
    // H√†m Utility: Hi·ªÉn th·ªã/·∫®n Control Overlay
    function toggleControlOverlay(state = 'default') {
        mainControlOverlay.classList.remove('default-view', 'expanded-view');
        if (state === 'default') {
            mainControlOverlay.classList.add('default-view');
        } else if (state === 'expanded') {
            mainControlOverlay.classList.add('expanded-view');
        }
    }
    
    // 1. Ch·ªâ cho ph√©p TOGGLE khi click v√†o TITLE
    mainControlOverlay.addEventListener('click', (e) => {
        // Ch·ªâ toggle n·∫øu click v√†o TI√äU ƒê·ªÄ ('overlayTitle')
        if (e.target.id === 'overlayTitle') { 
            if (mainControlOverlay.classList.contains('default-view')) {
                toggleControlOverlay('expanded');
            } else {
                toggleControlOverlay('default');
            }
        }
    });

    // 2. Th√™m s·ª± ki·ªán click MAP ƒë·ªÉ ·∫©n Overlay (Click Outside)
    map.on('click', () => {
        // Kh√¥ng ·∫©n n·∫øu ƒëang c√≥ cu·ªëc xe m·ªõi hi·ªÉn th·ªã (ƒë·ªÉ tr√°nh l√†m m·∫•t card th√¥ng b√°o)
        if (newRequestCard.style.display !== 'none') return; 
        
        // ·∫®n Overlay n·∫øu ƒëang ·ªü ch·∫ø ƒë·ªô m·ªü r·ªông
        if (mainControlOverlay.classList.contains('expanded-view')) {
            toggleControlOverlay('default');
        }
    });
    
    toggleControlOverlay('expanded'); // M·∫∑c ƒë·ªãnh m·ªü r·ªông ƒë·ªÉ th·∫•y n√∫t Online

    // === H√ÄM PH√ÅT √ÇM THANH V√Ä RUNG ===
    function notifyNewRide() {
        if (navigator.vibrate) {
            navigator.vibrate([500, 250, 500]); 
        }
        try {
            // S·ª≠ d·ª•ng √¢m thanh c√≥ s·∫µn, c√≥ th·ªÉ thay ƒë·ªïi URL
            const audio = new Audio('https://www.soundjay.com/buttons/beep-07a.mp3'); 
            audio.play();
        } catch (e) {
            console.warn('Kh√¥ng th·ªÉ ph√°t √¢m thanh:', e);
        }
    }
    // ===========================================

    // --- C·∫≠p nh·∫≠t UI theo tr·∫°ng th√°i ---
    function updateDriverUI(status) {
        const name = driverNameInput.value || 'T√†i x·∫ø';
        
        // 1. TOP STATUS
        if (status === 'online') {
            topStatus.innerHTML = `<span style="color:#28a745;">&#9679;</span> ${name.split('-')[0].trim()} Online`;
            topStatus.style.backgroundColor = 'rgba(0, 0, 0, 0.85)';
        } else if (status === 'offline') {
            topStatus.innerHTML = `<span style="color:#dc3545;">&#9679;</span> ƒê√£ Offline`;
            topStatus.style.backgroundColor = 'rgba(0, 0, 0, 0.85)';
        } else {
            topStatus.innerHTML = 'ƒêang k·∫øt n·ªëi...';
            topStatus.style.backgroundColor = 'rgba(255, 193, 7, 0.9)';
        }

        // 2. MAIN CONTROL OVERLAY
        if (status === 'offline') {
            offlineOnlineControls.style.display = 'block';
            activeRideContent.style.display = 'none';
            goOnlineBtn.style.display = 'block';
            goOfflineBtn.style.display = 'none';
            document.getElementById('driverNameInput').style.display = 'block';
            document.getElementById('overlayTitle').innerText = 'B·∫£ng ƒêi·ªÅu Khi·ªÉn (Offline)';
            toggleControlOverlay('expanded'); // M·ªü r·ªông ƒë·ªÉ d·ªÖ d√†ng nh·∫≠p t√™n v√† Online
        } else {
            document.getElementById('driverNameInput').style.display = 'none';
            goOnlineBtn.style.display = 'none';
            goOfflineBtn.style.display = 'block';
            // N·ªôi dung kh√°c ƒë∆∞·ª£c qu·∫£n l√Ω b·ªüi h√†m checkAndShowRide
        }
    }


    // --- H√ÄM ONLINE/OFFLINE CH√çNH ---
    async function setDriverOnline(name, lat, lng) {
        const dRef = ref(db, 'drivers/' + DRIVER_ID);
        await set(dRef, { id: DRIVER_ID, name, lat, lng, online: true, updatedAt: Date.now() });
        updateDriverUI('online');
        toggleControlOverlay('default'); // Thu nh·ªè sau khi Online
    }
    
    async function setDriverOffline() {
        const dRef = ref(db, 'drivers/' + DRIVER_ID);
        await remove(dRef).catch(()=>{});
        updateDriverUI('offline');
        newRequestCard.style.display = 'none';
        activeRideContent.style.display = 'none';
        offlineOnlineControls.style.display = 'block';
        goOfflineBtn.style.display = 'none';
        goOnlineBtn.style.display = 'block';
        // X√≥a t·∫•t c·∫£ c√°c route/marker kh√°c kh·ªèi map (tr·ª´ driverMarker)
        Object.keys(shownRides).forEach(id => {
            if (shownRides[id].routeControl) map.removeControl(shownRides[id].routeControl);
        });
        shownRides = {};
    }

    // ... (Gi·ªØ nguy√™n c√°c h√†m updateDriverLocation, startWatch, stopWatch, saveDriverState, loadDriverState) ...
    function saveDriverState(isOnline, name) {
        localStorage.setItem(STORAGE_KEY_STATUS, isOnline ? 'online' : 'offline');
        localStorage.setItem(STORAGE_KEY_NAME, name);
    }
    function loadDriverState() {
        const savedName = localStorage.getItem(STORAGE_KEY_NAME);
        if (savedName) driverNameInput.value = savedName;
        updateDriverUI(localStorage.getItem(STORAGE_KEY_STATUS) === 'online' ? 'online' : 'offline');
        if (localStorage.getItem(STORAGE_KEY_STATUS) === 'online') {
            setTimeout(() => goOnlineBtn.click(), 100); 
        }
    }
    async function updateDriverLocation(lat, lng) {
        lastPos = { lat, lng };
        driverMarker.setLatLng([lat,lng]);
        map.panTo([lat,lng]);
        if (!online) return;
        const dRef = ref(db, 'drivers/' + DRIVER_ID);
        await update(dRef, { lat, lng, updatedAt: Date.now() }).catch(()=>{});
        
        Object.keys(shownRides).forEach(rideId => {
            const s = shownRides[rideId];
            if (s.accepted) { 
                const rideRef = ref(db, 'rides/' + rideId);
                update(rideRef, { driverLat: lat, driverLng: lng });
                if (s.routeControl) {
                    const waypoints = s.routeControl.getWaypoints();
                    if (waypoints.length > 0) {
                        waypoints[0].latLng = L.latLng(lat, lng);
                        s.routeControl.setWaypoints(waypoints);
                    }
                }
            }
        });
    }
    function startWatch() {
      if (!navigator.geolocation) { alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã'); return; }
      navigator.geolocation.getCurrentPosition(async (p) => {
        await updateDriverLocation(p.coords.latitude, p.coords.longitude);
      }, ()=>{}, { enableHighAccuracy:true });
      
      watchId = navigator.geolocation.watchPosition(async (p) => {
        await updateDriverLocation(p.coords.latitude, p.coords.longitude);
      }, (err)=>console.warn(err), { enableHighAccuracy:true, maximumAge:2000, timeout:10000 });
    }
    function stopWatch() { if (watchId) navigator.geolocation.clearWatch(watchId); watchId = null; }
    // =========================================================

    // --- L·∫Øng nghe Firebase (ridesRef) ---
    const ridesRef = ref(db, 'rides');
    
    onChildAdded(ridesRef, (snap) => {
      const ride = snap.val(); const rideId = snap.key;
      if (!online || !ride || !lastPos) return;
      checkAndShowRide(rideId, ride);
    });

    onChildChanged(ridesRef, (snap) => {
      const ride = snap.val(); const rideId = snap.key;
      if (!online || !ride || (ride.status !== 'finding' && ride.driverId !== DRIVER_ID)) {
        removeRideFromUI(rideId);
        return;
      }
      if (lastPos) checkAndShowRide(rideId, ride);
    });

    onChildRemoved(ridesRef, (snap) => {
        const rideId = snap.key;
        removeRideFromUI(rideId, shownRides[rideId]?.accepted || false);
    });


    function checkAndShowRide(rideId, rideObj) {
        if (!rideObj.from) return;
        
        // --- B·ªï sung ki·ªÉm tra v·ªã tr√≠ t√†i x·∫ø ƒë√£ ƒë∆∞·ª£c l·∫•y ---
        if (!lastPos) {
             console.warn("Ch∆∞a c√≥ v·ªã tr√≠ t√†i x·∫ø ƒë·ªÉ t√≠nh kho·∫£ng c√°ch.");
             return;
        }
        // --- K·∫øt th√∫c b·ªï sung ---

        const driverPt = turf.point([lastPos.lng, lastPos.lat]);
        const pickupPt = turf.point([rideObj.from.lng, rideObj.from.lat]);
        const d = turf.distance(driverPt, pickupPt, { units: 'kilometers' });
        
        const isFindingAndNear = (rideObj.status === 'finding' && d <= 3);
        const isAcceptedByMe = (rideObj.driverId === DRIVER_ID && (rideObj.status === 'accepted' || rideObj.status === 'onTrip'));
        
        // 1. HI·ªÇN TH·ªä CU·ªêC M·ªöI (NEW REQUEST CARD)
        if (isFindingAndNear) {
            // N·∫øu ƒë√£ c√≥ cu·ªëc ƒëang ho·∫°t ƒë·ªông, b·ªè qua cu·ªëc m·ªõi ƒëang t√¨m
            const activeRideId = Object.keys(shownRides).find(id => shownRides[id].accepted === true);
            if (activeRideId) return; 
            
            // Ch·ªâ hi·ªán 1 cu·ªëc m·ªõi ƒëang ch·ªù (n·∫øu c√≥ cu·ªëc ƒëang ch·ªù kh√°c, kh√¥ng g·ªçi l·∫°i notify)
            const findingRideId = Object.keys(shownRides).find(id => shownRides[id].currentStatus === 'finding');
            if (!findingRideId) {
                createRequestCard(rideId, rideObj, d);
                notifyNewRide(); // Ch·ªâ g·ªçi notify khi th·ª±c s·ª± t·∫°o card m·ªõi
            } else if (findingRideId !== rideId) {
                 return;
            }

            // ·∫®n n·ªôi dung ch√≠nh, ch·ªâ ƒë·ªÉ n√∫t Online/Offline n·∫øu c·∫ßn
            activeRideContent.style.display = 'none';
            offlineOnlineControls.style.display = 'block'; 
            document.getElementById('overlayTitle').innerText = `Ch·ªù ch·∫•p nh·∫≠n Cu·ªëc #${rideId.slice(-4)}`;
            toggleControlOverlay('default'); // Gi·ªØ nh·ªè overlay ch√≠nh
        } 
        
        // 2. HI·ªÇN TH·ªä CU·ªêC ƒêANG HO·∫†T ƒê·ªòNG (ACTIVE RIDE CONTENT)
        else if (isAcceptedByMe) {
            const isNewActiveRide = !shownRides[rideId] || shownRides[rideId].accepted === false;

            if (isNewActiveRide) {
                // L·∫ßn ƒë·∫ßu ti√™n nh·∫≠n cu·ªëc
                createActiveRideUI(rideId, rideObj, d);
            }
            updateActiveRideUI(rideId, rideObj, d);
            
            // Hi·ªán n·ªôi dung chuy·∫øn ƒëi, ·∫©n ƒëi·ªÅu khi·ªÉn Online/Offline
            offlineOnlineControls.style.display = 'none';
            activeRideContent.style.display = 'block';
            document.getElementById('overlayTitle').innerText = `Cu·ªëc ƒëang ch·∫°y #${rideId.slice(-4)}`;
            newRequestCard.style.display = 'none';

            // **FIX HERE:** M·ªü r·ªông Overlay M·ªòT L·∫¶N ƒë·ªÉ t√†i x·∫ø xem chi ti·∫øt cu·ªëc xe m·ªõi ch·∫•p nh·∫≠n
            if (isNewActiveRide) {
                 toggleControlOverlay('expanded');
            }
        } 
        
        // 3. X√ìA N·∫æU KH√îNG C√íN LI√äN QUAN
        else {
            removeRideFromUI(rideId);
        }
    }
    
    // --- H√ÄM T·∫†O UI CHO CU·ªêC M·ªöI (NEW REQUEST) ---
    function createRequestCard(rideId, rideObj, distKm) {
        if (shownRides[rideId]) return;

        // X√≥a t·∫•t c·∫£ c√°c cu·ªëc ƒëang ch·ªù kh√°c tr∆∞·ªõc khi hi·ªÉn th·ªã cu·ªëc m·ªõi
        Object.keys(shownRides).forEach(id => {
            if (shownRides[id].accepted === false) removeRideFromUI(id);
        });
        
        const pickup = `${rideObj.fromText || '‚Äî'}`;
        const dest = `${rideObj.toText || '‚Äî'}`;
        
        newRequestCard.innerHTML = `
            <h3>üõé CU·ªêC M·ªöI (#${rideId.slice(-4)})</h3>
            <div style="font-size: 0.9em; margin-bottom: 5px;">
                C√°ch: ${distKm.toFixed(2)} km. ƒê·∫øn: ${dest.split(',').slice(0, 2).join(',')}
            </div>
            <div style="font-weight: bold; color: var(--danger-color); margin-bottom: 5px;">
                Gi√°: ${rideObj.fare ? rideObj.fare.toLocaleString() + ' ƒë' : '‚Äî'}
            </div>
            <div class="row">
                <button id="acceptBtn_${rideId}" class="btn btn-accept col">CH·∫§P NH·∫¨N</button>
                <button id="rejectBtn_${rideId}" class="btn btn-secondary col">T·ª™ CH·ªêI</button>
            </div>
        `;
        // ƒê·∫£m b·∫£o card ƒë∆∞·ª£c hi·ªÉn th·ªã
        newRequestCard.style.display = 'block'; 

        document.getElementById(`acceptBtn_${rideId}`).onclick = () => acceptRide(rideId, rideObj);
        document.getElementById(`rejectBtn_${rideId}`).onclick = () => removeRideFromUI(rideId);
        
        // Ch·ªâ l∆∞u cu·ªëc m·ªõi v√†o shownRides
        shownRides[rideId] = { el: newRequestCard, routeControl: null, accepted: false, currentStatus: 'finding' };
    }
    
    // --- H√ÄM T·∫†O UI CHO CU·ªêC ƒêANG HO·∫†T ƒê·ªòNG (ACTIVE RIDE) ---
    function createActiveRideUI(rideId, rideObj, distKm) {
        // X√≥a t·∫•t c·∫£ c√°c cu·ªëc ƒëang ch·ªù kh√°c
        Object.keys(shownRides).forEach(id => {
            if (id !== rideId && !shownRides[id].accepted) removeRideFromUI(id);
        });

        if (shownRides[rideId]) {
             if (shownRides[rideId].routeControl) map.removeControl(shownRides[rideId].routeControl);
             // X√≥a n·∫øu n√≥ l√† th·∫ª ch·ªù v√† thay th·∫ø b·∫±ng th·∫ª ho·∫°t ƒë·ªông
             if (!shownRides[rideId].accepted) delete shownRides[rideId];
             else return; // ƒê√£ l√† cu·ªëc ho·∫°t ƒë·ªông, kh√¥ng t·∫°o l·∫°i
        }

        const pickup = `${rideObj.fromText || '‚Äî'}`;
        const dest = `${rideObj.toText || '‚Äî'}`;

        document.getElementById('rideDetails').innerHTML = `
            <div><b><span style="color:var(--secondary-color);">ƒê√≥n Kh√°ch:</span></b> ${pickup}</div>
            <div style="margin-top: 5px;"><b><span style="color:var(--primary-color);">ƒêi·ªÉm ƒê·∫øn:</span></b> ${dest}</div>
            <div style="margin-top: 5px;"><b>Kho·∫£ng c√°ch:</b> ${(rideObj.distance_m / 1000).toFixed(2)} km</div>
            <div style="font-weight: bold; color: var(--success-color); margin-top: 5px;">
                Gi√° cu·ªëc: ${rideObj.fare ? rideObj.fare.toLocaleString() + ' ƒë' : '‚Äî'}
            </div>
        `;

        document.getElementById('cancelActiveRideBtn').onclick = () => cancelRide(rideId);

        shownRides[rideId] = { routeControl: null, accepted: true, currentStatus: rideObj.status };
    }
    
    // --- H√ÄM C·∫¨P NH·∫¨T UI CHO CU·ªêC ƒêANG HO·∫†T ƒê·ªòNG ---
    function updateActiveRideUI(rideId, rideObj, distKm) {
        const s = shownRides[rideId];
        if (!s || s.accepted === false) return; // Kh√¥ng t√¨m th·∫•y cu·ªëc ho·∫°t ƒë·ªông

        // N·∫øu status kh√¥ng ƒë·ªïi v√† ƒë√£ v·∫Ω route, kh√¥ng c·∫ßn l√†m g√¨
        if (s.currentStatus === rideObj.status && s.routeControl) return; 

        s.currentStatus = rideObj.status;
        const actionsDiv = document.getElementById('activeRideActions');
        actionsDiv.innerHTML = '';

        const fromLat = rideObj.from.lat;
        const fromLng = rideObj.from.lng;
        const toLat = rideObj.to.lat;
        const toLng = rideObj.to.lng;

        // X√≥a route c≈©
        if (s.routeControl) { map.removeControl(s.routeControl); s.routeControl = null; }

        let waypoints;
        let actionBtn;
        let statusTitleText;

        if (rideObj.status === 'accepted') {
            // ƒê·∫øn ƒëi·ªÉm ƒë√≥n
            waypoints = [ L.latLng(lastPos.lat, lastPos.lng), L.latLng(fromLat, fromLng) ]; 
            statusTitleText = 'ƒêang ch·∫°y ƒë·∫øn ƒë√≥n kh√°ch';
            actionBtn = document.createElement('button');
            actionBtn.className = 'btn btn-primary col';
            actionBtn.innerText = 'ƒê√É ƒê√ìN KH√ÅCH (Start Trip)';
            actionBtn.onclick = () => startTrip(rideId);
        } else if (rideObj.status === 'onTrip') {
            // ƒê·∫øn ƒëi·ªÉm ƒë·∫øn
            waypoints = [ L.latLng(lastPos.lat, lastPos.lng), L.latLng(toLat, toLng) ]; 
            statusTitleText = 'ƒêANG TR√äN ƒê∆Ø·ªúNG';
            actionBtn = document.createElement('button');
            actionBtn.className = 'btn btn-complete col';
            actionBtn.innerText = 'HO√ÄN TH√ÄNH CU·ªêC';
            actionBtn.onclick = () => completeRide(rideId);
        }
        
        document.getElementById('rideStatusTitle').innerHTML = `<span style="color:var(--success-color);">${statusTitleText}</span>`;
        actionsDiv.appendChild(actionBtn);

        // V·∫Ω Route m·ªõi
        s.routeControl = L.Routing.control({
            waypoints,
            router: L.Routing.osrmv1({serviceUrl: 'https://router.project-osrm.org/route/v1'}),
            fitSelectedRoutes: true,
            addWaypoints: false,
            showAlternatives: false,
            lineOptions: { styles: [{ color: '#007bff', weight: 6, opacity: 0.7 }] } 
        }).addTo(map);
        s.routeControl.route(); 
    }
    
    // --- H√ÄM X√ìA UI (X·ª≠ l√Ω h·ªßy chuy·∫øn) ---
    function removeRideFromUI(rideId, wasActive = false) {
        if (!shownRides[rideId]) return;

        if (shownRides[rideId].routeControl) { 
            try { map.removeControl(shownRides[rideId].routeControl); } catch(e){} 
        }
        
        // Ch·ªâ x√≥a item trong shownRides n·∫øu n√≥ kh√¥ng ph·∫£i cu·ªëc ƒëang ho·∫°t ƒë·ªông c·ªßa m√¨nh
        if (shownRides[rideId].accepted === false || (shownRides[rideId].accepted === true && rideId === Object.keys(shownRides).find(id => shownRides[id].accepted === true))) {
             delete shownRides[rideId];
        } else {
             return; // Kh√¥ng x√≥a cu·ªëc ƒëang ho·∫°t ƒë·ªông
        }
        
        newRequestCard.style.display = 'none';

        // TH√îNG B√ÅO H·ª¶Y CHUY·∫æN ƒêANG HO·∫†T ƒê·ªòNG
        if (wasActive) { 
            alert(`Th√¥ng b√°o: Kh√°ch h√†ng ƒë√£ H·ª¶Y cu·ªëc xe #${rideId.slice(-4)}. Quay l·∫°i tr·∫°ng th√°i t√¨m cu·ªëc.`);
        }
        
        // Quay v·ªÅ tr·∫°ng th√°i Online r·∫£nh r·ªói (ho·∫∑c Offline n·∫øu ƒëang Offline)
        if (online) {
            activeRideContent.style.display = 'none';
            offlineOnlineControls.style.display = 'block';
            document.getElementById('overlayTitle').innerText = 'B·∫£ng ƒêi·ªÅu Khi·ªÉn (Online)';
            toggleControlOverlay('default');
        } else {
             updateDriverUI('offline');
        }
    }

    // --- H√ÄM X·ª¨ L√ù N√öT CHUY·∫æN ƒêI (Gi·ªØ nguy√™n logic) ---
    async function startTrip(rideId) {
        if (!confirm("X√°c nh·∫≠n b·∫°n ƒë√£ ƒë√≥n kh√°ch v√† b·∫Øt ƒë·∫ßu h√†nh tr√¨nh ƒë·∫øn ƒëi·ªÉm ƒë·∫øn?")) return;
        try {
            const rideRef = ref(db, 'rides/' + rideId);
            await update(rideRef, { status: 'onTrip', startedTripAt: Date.now() });
        } catch (e) { alert('L·ªói khi b·∫Øt ƒë·∫ßu h√†nh tr√¨nh: ' + (e.message || e)); }
    }
    async function cancelRide(rideId) {
        if (!confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën h·ªßy cu·ªëc xe n√†y? Vi·ªác h·ªßy s·∫Ω th√¥ng b√°o cho kh√°ch v√† x√≥a cu·ªëc xe.")) return;
        try {
            const rideRef = ref(db, 'rides/' + rideId);
            await remove(rideRef); 
            removeRideFromUI(rideId, true);
        } catch (e) { alert('L·ªói h·ªßy chuy·∫øn: ' + (e.message || e)); }
    }
    async function acceptRide(rideId, rideObj) {
      newRequestCard.style.display = 'none';
      const rideRef = ref(db, 'rides/' + rideId);
      onValue(rideRef, async (snap) => {
        const current = snap.val();
        if (!current) { alert('Cu·ªëc ƒë√£ b·ªã h·ªßy'); removeRideFromUI(rideId, true); return; } 
        if (current.status && current.status !== 'finding') { alert('Cu·ªëc ƒë√£ ƒë∆∞·ª£c nh·∫≠n b·ªüi ng∆∞·ªùi kh√°c'); removeRideFromUI(rideId); return; }

        const driverName = driverNameInput.value || ('T√†i x·∫ø_' + DRIVER_ID.slice(-4));
        await update(rideRef, {
          status: 'accepted',
          driverId: DRIVER_ID,
          driverName,
          driverLat: lastPos.lat,
          driverLng: lastPos.lng,
          acceptedAt: Date.now()
        });
        // Sau khi update th√†nh c√¥ng, onChildChanged s·∫Ω k√≠ch ho·∫°t checkAndShowRide v√† v·∫Ω UI m·ªõi
        // checkAndShowRide s·∫Ω t·ª± ƒë·ªông m·ªü r·ªông Overlay n·∫øu ƒë√¢y l√† cu·ªëc m·ªõi ƒë∆∞·ª£c ch·∫•p nh·∫≠n
      }, { onlyOnce: true });
    }
    async function completeRide(rideId) {
      if (!confirm("X√°c nh·∫≠n ƒë√£ ho√†n th√†nh cu·ªëc xe?")) return;
      const rideRef = ref(db, 'rides/' + rideId);
      onValue(rideRef, async (snap) => {
        const current = snap.val();
        if (!current) { removeRideFromUI(rideId); return; }
        const historyRef = ref(db, 'history');
        const entry = { ...current, completedAt: Date.now(), completedBy: DRIVER_ID };
        await push(historyRef, entry);
        await remove(rideRef).catch(()=>{});
        removeRideFromUI(rideId);
      }, { onlyOnce: true });
    }
    
    // --- EVENT LISTENERS CHUNG ---
    goOnlineBtn.addEventListener('click', async () => {
      const name = driverNameInput.value || ('T√†i x·∫ø_' + DRIVER_ID.slice(-4));
      if (name.length < 5) { alert("Vui l√≤ng nh·∫≠p T√™n v√† Bi·ªÉn s·ªë xe ƒë·ªÉ Online."); return; }
      online = true;
      updateDriverUI('connecting');
      startWatch();
      saveDriverState(true, name);

      setTimeout(async () => {
        if (!lastPos) {
          alert('Kh√¥ng l·∫•y ƒë∆∞·ª£c v·ªã tr√≠ ‚Äî ki·ªÉm tra quy·ªÅn truy c·∫≠p v·ªã tr√≠');
          online = false;
          setDriverOffline(); 
          saveDriverState(false, name);
          return;
        }
        await setDriverOnline(name, lastPos.lat, lastPos.lng);
      }, 900);
    });

    goOfflineBtn.addEventListener('click', async () => {
      online = false;
      stopWatch();
      await setDriverOffline();
      saveDriverState(false, driverNameInput.value);
    });

    window.addEventListener('beforeunload', async () => {
      if (online) { await setDriverOffline(); }
    });

    loadDriverState(); 
  </script>
</body>
</html>
